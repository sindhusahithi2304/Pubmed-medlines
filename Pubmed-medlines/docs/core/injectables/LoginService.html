<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Core</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">Core</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">







<ol class="breadcrumb">
  <li>Injectables</li>
  <li>LoginService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>login/login.service.ts</code>
        </p>

            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>A high-level service to manage user login</p>

            </p>



            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#complete">complete</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#getCredentials">getCredentials</a>
                            </li>
                            <li>
                                <a href="#login">login</a>
                            </li>
                            <li>
                                <a href="#logout">logout</a>
                            </li>
                            <li>
                                <a href="#ngOnDestroy">ngOnDestroy</a>
                            </li>
                            <li>
                                <a href="#overrideUser">overrideUser</a>
                            </li>
                        </ul>
                    </td>
                </tr>





                    <tr>
                        <td class="col-md-4">
                            <h6><b>Accessors</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                    <a href="#events">events</a>
                                </li>
                                <li>
                                    <a href="#principal">principal</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(startConfig: <a href="../interfaces/StartConfig.html">StartConfig</a>, loginModal: Type<any>, router: <a href="https://angular.io/api/router/Router" target="_blank">Router</a>, appService: <a href="../injectables/AppService.html">AppService</a>, principalService: <a href="../injectables/PrincipalWebService.html">PrincipalWebService</a>, userSettingsService: <a href="../injectables/UserSettingsWebService.html">UserSettingsWebService</a>, modalService: <a href="../injectables/ModalService.html">ModalService</a>, notificationsService: <a href="../injectables/NotificationsService.html">NotificationsService</a>, authenticationService: <a href="../injectables/AuthenticationService.html">AuthenticationService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="67" class="link-to-prism">login/login.service.ts:67</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>startConfig</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/StartConfig.html" target="_self" >StartConfig</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>loginModal</td>
                                                  
                                                        <td>
                                                                    <code>Type&lt;any&gt;</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>router</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://angular.io/api/router/Router" target="_blank" >Router</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>appService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/AppService.html" target="_self" >AppService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>principalService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/PrincipalWebService.html" target="_self" >PrincipalWebService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>userSettingsService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/UserSettingsWebService.html" target="_self" >UserSettingsWebService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>modalService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/ModalService.html" target="_self" >ModalService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>notificationsService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/NotificationsService.html" target="_self" >NotificationsService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>authenticationService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/AuthenticationService.html" target="_self" >AuthenticationService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getCredentials"></a>
                    <span class="name">
                        <b>
                            getCredentials
                        </b>
                        <a href="#getCredentials"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getCredentials(response: <a href="https://angular.io/api/common/http/HttpErrorResponse" target="_blank">HttpErrorResponse</a>, acceptCurrent: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank">boolean</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="280"
                            class="link-to-prism">login/login.service.ts:280</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Called by the <a href="HttpInterceptor">HttpInterceptor</a> on reception of an <code>HTTP 401</code> response.
This will either initiate an auto login process (OAuth/SAML) if configured on
the Sinequa server or display the login modal dialog to request user credentials</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>response</td>
                                    <td>
                                                <code><a href="https://angular.io/api/common/http/HttpErrorResponse" target="_blank" >HttpErrorResponse</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                    <td>
                                        <p>An <code>HTTP 401</code> response</p>

                                    </td>
                                </tr>
                                <tr>
                                    <td>acceptCurrent</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                    <td>
                                        <p>If <code>true</code> and the <code>AuthenticationService</code> currently has
processed credentials then use them instead of starting a new login</p>

                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        <p>A promise that is resolved when credentials have been obtained. Note that
when auto-authentication is configured the promise will be rejected and the browser
redirected to the OAuth/SAML redirect url</p>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="login"></a>
                    <span class="name">
                        <b>
                            login
                        </b>
                        <a href="#login"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>login()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="172"
                            class="link-to-prism">login/login.service.ts:172</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Initiate the user login process. The method attempts to retrieve
the <a href="../interfaces/CCApp.html">application configuration</a>, the
<a href="../interfaces/Principal.html">logged in user</a> and the <a href="../interfaces/UserSettings.html">user settings</a>.
If a user is not currently authenticated then authentication is performed using
the <a href="../injectables/AuthenticationService.html">AuthenticationService</a> - OAuth/SAML if configured on the Sinequa Server
or manual using a login modal dialog provided using the <a href="../miscellaneous/variables.html#MODAL_LOGIN">MODAL_LOGIN</a> injection
token.</p>
</div>

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../interfaces/LoginData.html" target="_self" >Observable&lt;LoginData&gt;</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="logout"></a>
                    <span class="name">
                        <b>
                            logout
                        </b>
                        <a href="#logout"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>logout()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="128"
                            class="link-to-prism">login/login.service.ts:128</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Perform a logout of the currently logged in user. <a href="../injectables/AppService.html#app">AppService.app</a>,
<a href="../injectables/PrincipalWebService.html#prinicpal">PrincipalWebService.principal</a> and
<a href="../injectables/UserSettingsWebService.html#userSettings">UserSettingsWebService.userSettings</a> are reset.
The <code>session-end</code> event is emitted</p>
</div>

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="ngOnDestroy"></a>
                    <span class="name">
                        <b>
                            ngOnDestroy
                        </b>
                        <a href="#ngOnDestroy"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>ngOnDestroy()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="87"
                            class="link-to-prism">login/login.service.ts:87</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="overrideUser"></a>
                    <span class="name">
                        <b>
                            overrideUser
                        </b>
                        <a href="#overrideUser"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>overrideUser(userOverride: <a href="../interfaces/UserOverride.html">UserOverride | undefined</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="145"
                            class="link-to-prism">login/login.service.ts:145</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Override the current user to the user specified in <code>userOverride</code>. Only an administrator
is permitted to do this. They can revert to the normal login by calling this method with
<code>undefined</code></p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>userOverride</td>
                                    <td>
                                                <code><a href="../interfaces/UserOverride.html" target="_self" >UserOverride | undefined</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                    <td>
                                        <p>The user override</p>

                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >void</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="complete"></a>
                        <span class="name">
                            <b>
                            complete</b>
                            <a href="#complete"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="61" class="link-to-prism">login/login.service.ts:61</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description"><p><code>true</code> if a user is currently logged in</p>
</div>
                    </td>
                </tr>

            </tbody>
        </table>
</section>

            <section>
    <h3 id="accessors">
        Accessors
    </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="events"></a>
                        <span class="name"><b>events</b><a href="#events"><span class="icon ion-ios-link"></span></a></span>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <span class="accessor"><b>get</b><code>events()</code></span>
                    </td>
                </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="95" class="link-to-prism">login/login.service.ts:95</a></div>
                                </td>
                            </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-description"><p>Get an <code>Observable</code> stream of <a href="../interfaces/SessionEvent.html">SessionEvent</a> events emitted by the service</p>
</div>

                                <div class="io-description">
                                    <b>Returns : </b>        <code><a href="../interfaces/SessionEvent.html" target="_self" >Observable&lt;SessionEvent&gt;</a></code>

                                </div>
                        </td>
                    </tr>

            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="principal"></a>
                        <span class="name"><b>principal</b><a href="#principal"><span class="icon ion-ios-link"></span></a></span>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <span class="accessor"><b>get</b><code>principal()</code></span>
                    </td>
                </tr>
                            <tr>
                                <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="104" class="link-to-prism">login/login.service.ts:104</a></div>
                                </td>
                            </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-description"><p>Get the currently logged in <a href="../interfaces/Principal.html">Principal</a>, if any. Note that a principal can exist
without the login being complete. For example, in the situation where access is denied to
the selected app.</p>
</div>

                                <div class="io-description">
                                    <b>Returns : </b>        <code><a href="../interfaces/Principal.html" target="_self" >Principal | undefined</a></code>

                                </div>
                        </td>
                    </tr>

            </tbody>
        </table>
</section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {Injectable, Inject, OnDestroy, Type, InjectionToken, Optional} from &quot;@angular/core&quot;;
import {HttpErrorResponse} from &quot;@angular/common/http&quot;;
import {Router} from &quot;@angular/router&quot;;
import {BehaviorSubject, Observable, forkJoin, of, throwError} from &quot;rxjs&quot;;
import {flatMap} from &quot;rxjs/operators&quot;;
import {Utils, SqError, SqErrorCode} from &quot;@sinequa/core/base&quot;;
import {START_CONFIG, StartConfig, CCApp, PrincipalWebService, Principal,
    UserSettingsWebService, UserSettings} from &quot;@sinequa/core/web-services&quot;;
import {ModalService, ModalResult} from &quot;@sinequa/core/modal&quot;;
import {NotificationsService} from &quot;@sinequa/core/notification&quot;;
import {AppService} from &quot;@sinequa/core/app-utils&quot;;
import {AuthenticationService, ProcessedCredentials, Credentials, UserOverride} from &quot;./authentication.service&quot;;

/**
 * Describes the different session events that are emitted by the {@link LoginService}
 * * &#x60;session-start&#x60;: emitted after successful login
 * * &#x60;session-end&#x60;: emitted after logout and also when the {@link LoginService} is destroyed
 * * &#x60;session-changed&#x60;: emitted whenever the login state changes - login, logout and user override
 */
export interface SessionEvent {
    type: &quot;session-start&quot; | &quot;session-end&quot; | &quot;session-changed&quot;;
}


/**
 * An &#x60;InjectionToken&#x60; to set the component to use for the login modal dialog which is displayed
 * by the {@link LoginService} when performing a manual login. This makes the service independent
 * of any particular UI framework. If manual login is to be used a component must be configured by
 * providing this token.
 */
export const MODAL_LOGIN &#x3D; new InjectionToken&lt;Type&lt;any&gt;&gt;(&#x27;MODAL_LOGIN&#x27;);

/**
 * Describes the data retrieved during the login process.
 */
export interface LoginData {
    /**
     * The application configuration.
     */
    app: CCApp;
    /**
     * The principal corresponding to the logged in user.
     */
    principal: Principal;
    /**
     * The user settings for the logged in user.
     */
    userSettings: UserSettings;
}

/**
 * A high-level service to manage user login
 */
@Injectable({
    providedIn: &quot;root&quot;
})
export class LoginService implements OnDestroy {
    /**
     * &#x60;true&#x60; if a user is currently logged in
     */
    complete: boolean;
    // getCredentials handling (concurrent calls)
    protected loginModalPromise: Promise&lt;ModalResult&gt; | undefined;
    protected processCredentialsPromise: Promise&lt;ProcessedCredentials | undefined&gt; | undefined;
    protected checkPrincipalPromise: Promise&lt;Principal&gt; | undefined;
    protected automaticLoginPromise: Promise&lt;any&gt; | undefined;
    protected _events &#x3D; new BehaviorSubject&lt;SessionEvent&gt;({type: &quot;session-changed&quot;});

    constructor(
        @Inject(START_CONFIG) protected startConfig: StartConfig,
        @Inject(MODAL_LOGIN) protected loginModal: Type&lt;any&gt;,
        @Optional() protected router: Router,
        protected appService: AppService,
        protected principalService: PrincipalWebService,
        protected userSettingsService: UserSettingsWebService,
        protected modalService: ModalService,
        protected notificationsService: NotificationsService,
        protected authenticationService: AuthenticationService) {
        // NB unload doesn&#x27;t fire reliably so we listen for beforeunload
        window.addEventListener(&quot;beforeunload&quot;, this.beforeUnloadEventListener);
    }

    protected beforeUnloadEventListener &#x3D; (e: Event) &#x3D;&gt; {
        this._events.next({type: &quot;session-end&quot;});
    }

    ngOnDestroy() {
        this._events.complete();
        window.removeEventListener(&quot;beforeunload&quot;, this.beforeUnloadEventListener);
    }

    /**
     * Get an &#x60;Observable&#x60; stream of {@link SessionEvent} events emitted by the service
     */
    get events(): Observable&lt;SessionEvent&gt; {
        return this._events;
    }

    /**
     * Get the currently logged in {@link Principal}, if any. Note that a principal can exist
     * without the login being complete. For example, in the situation where access is denied to
     * the selected app.
     */
    get principal(): Principal | undefined {
        return this.principalService.principal;
    }

    private setComplete() {
        const complete &#x3D; this.complete;
        this.complete &#x3D; !!this.appService.app &amp;&amp; !!this.principalService.principal &amp;&amp; !!this.userSettingsService.userSettings;
        if (this.complete) {
            if (!this.authenticationService.userOverrideFailed) {
                this.notificationsService.hideNotifications();
            }
            this.authenticationService.userOverrideFailed &#x3D; false;
        }
        if (!!complete !&#x3D;&#x3D; !!this.complete) {
            this._events.next({type: &quot;session-changed&quot;});
        }
    }

    /**
     * Perform a logout of the currently logged in user. [AppService.app]{@link AppService#app},
     * [PrincipalWebService.principal]{@link PrincipalWebService#prinicpal} and
     * [UserSettingsWebService.userSettings]{@link UserSettingsWebService#userSettings} are reset.
     * The &#x60;session-end&#x60; event is emitted
     */
    logout() {
        this._events.next({type: &quot;session-end&quot;});
        this.appService.clear();
        this.principalService.principal &#x3D; undefined;
        this.userSettingsService.userSettings &#x3D; undefined;
        this.authenticationService.deactivateUserOverride();
        this.authenticationService.logout();
        this.setComplete();
    }

    /**
     * Override the current user to the user specified in &#x60;userOverride&#x60;. Only an administrator
     * is permitted to do this. They can revert to the normal login by calling this method with
     * &#x60;undefined&#x60;
     *
     * @param userOverride The user override
     */
    overrideUser(userOverride: UserOverride | undefined) {
        this.authenticationService.userOverride &#x3D; userOverride;
        this.appService.clear();
        this.principalService.principal &#x3D; undefined;
        this.userSettingsService.userSettings &#x3D; undefined;
        this.setComplete();
        Utils.delay().then(() &#x3D;&gt; this.login());
    }

    private switchPrincipal(principal: Principal) {
        if (!principal.isAdministrator) {
            this.authenticationService.deactivateUserOverride();
        }
        this.principalService.principal &#x3D; principal;
        this.userSettingsService.userSettings &#x3D; undefined;
        Utils.delay().then(() &#x3D;&gt; this.login());
    }

    /**
     * Initiate the user login process. The method attempts to retrieve
     * the [application configuration]{@link CCApp}, the
     * [logged in user]{@link Principal} and the [user settings]{@link UserSettings}.
     * If a user is not currently authenticated then authentication is performed using
     * the {@link AuthenticationService} - OAuth/SAML if configured on the Sinequa Server
     * or manual using a login modal dialog provided using the {@link MODAL_LOGIN} injection
     * token.
     */
    login(): Observable&lt;LoginData&gt; {
        const appName &#x3D; this.appService.appName;
        if (!appName) {
            return throwError({error: &quot;App not specified&quot;});
        }
        let appNeeded: boolean;
        if (this.router) {
            const hash &#x3D; window.location.hash.replace(&quot;#&quot;, &quot;&quot;);
            const href &#x3D; hash.split(&quot;?&quot;)[0];
            const params &#x3D; new URLSearchParams(hash.split(&quot;?&quot;)[1]);
            const queryParams &#x3D; {}
            params.forEach((v, k) &#x3D;&gt; queryParams[k] &#x3D; v);

            // Pick up any user override from the query string
            const overrideUser &#x3D; queryParams[&quot;overrideUser&quot;];
            const overrideDomain &#x3D; queryParams[&quot;overrideDomain&quot;];
            if (overrideUser) {
                this.authenticationService.userOverride &#x3D; {
                    userName: overrideUser,
                    domain: overrideDomain
                };
                delete queryParams[&quot;overrideUser&quot;];
                delete queryParams[&quot;overrideDomain&quot;];
                const url &#x3D; Utils.makeURL(href);
                this.router.navigate([url.pathname], {queryParams});
            }
        }

        interface ObservableLoginData {
            app: Observable&lt;CCApp&gt; | undefined;
            principal: Observable&lt;Principal&gt; | undefined;
            userSettings: Observable&lt;UserSettings&gt; | undefined;
        }

        const makeObservables &#x3D; (): ObservableLoginData &#x3D;&gt; {
            const observables: ObservableLoginData &#x3D; {
                app: undefined,
                principal: undefined,
                userSettings: undefined
            };
            if (!this.appService.app || (appName &amp;&amp; this.appService.app.name !&#x3D;&#x3D; appName)) {
                appNeeded &#x3D; true;
                observables.app &#x3D; this.appService.init();
            }
            else {
                observables.app &#x3D; of(this.appService.app);
            }
            let loadUserSettings &#x3D; false;
            if (!this.principalService.principal) {
                loadUserSettings &#x3D; true;
                observables.principal &#x3D; this.principalService.load();
            }
            else {
                observables.principal &#x3D; of(this.principalService.principal);
            }
            if (!this.userSettingsService.userSettings || loadUserSettings) {
                observables.userSettings &#x3D; this.userSettingsService.load();
            }
            else {
                observables.userSettings &#x3D; of(this.userSettingsService.userSettings);
            }
            return observables;
        };

        const observable &#x3D; this.authenticationService.autoAuthenticate()
            .pipe(flatMap((success) &#x3D;&gt; {
                const observables &#x3D; makeObservables();
                return forkJoin&lt;ObservableLoginData, keyof ObservableLoginData&gt;(observables);
            }));
        Utils.subscribe(observable,
            (result) &#x3D;&gt; {
                console.log(&quot;loginService.login ok: &quot;, result);
                this.setComplete();
                if (appNeeded) {
                    this._events.next({type: &quot;session-start&quot;});
                }
            },
            (error) &#x3D;&gt; {
                console.log(&quot;loginService.login failed: &quot;, error);
                // proceed to logout to clean process
                this.logout();
                return throwError(error);
            });
        return observable;
    }

    private getAutomaticProvider(): string | undefined {
        if (this.startConfig.providers) {
            return Object.keys(this.startConfig.providers).find((value) &#x3D;&gt; {
                const provider &#x3D; this.startConfig.providers &amp;&amp; this.startConfig.providers[value];
                return !!provider &amp;&amp; (provider as any).automatic;
            });
        }
        return undefined;
    }

    /**
     * Called by the {@link HttpInterceptor} on reception of an &#x60;HTTP 401&#x60; response.
     * This will either initiate an auto login process (OAuth/SAML) if configured on
     * the Sinequa server or display the login modal dialog to request user credentials
     *
     * @param response An &#x60;HTTP 401&#x60; response
     * @param acceptCurrent If &#x60;true&#x60; and the &#x60;AuthenticationService&#x60; currently has
     * processed credentials then use them instead of starting a new login
     * @returns A promise that is resolved when credentials have been obtained. Note that
     * when auto-authentication is configured the promise will be rejected and the browser
     * redirected to the OAuth/SAML redirect url
     */
    getCredentials(response: HttpErrorResponse, acceptCurrent: boolean): Promise&lt;void&gt; {
        if (acceptCurrent &amp;&amp; this.authenticationService.processedCredentials) {
            return Promise.resolve(); // initiate retry
        }
        if (!this.startConfig.usePopupForLogin &amp;&amp; this.authenticationService.autoLoginActive) {
            return this.authenticationService.autoAuthenticate().toPromise()
                .then(result &#x3D;&gt; {
                    if (result/*auto-authentication initiated*/) {
                        return Promise.reject(&quot;performing auto login&quot;);
                    }
                    else {
                        return undefined;
                    }
                });
        }
        let firstCaller &#x3D; false;
        const automaticProvider &#x3D; this.getAutomaticProvider();
        if (automaticProvider) {
            if (!this.automaticLoginPromise) {
                this.automaticLoginPromise &#x3D; this.authenticationService.authenticateWithProvider(automaticProvider).toPromise();
                firstCaller &#x3D; true;
            }
            return this.automaticLoginPromise
                .then((result) &#x3D;&gt; {
                    // NB response should be the return value from JOAuth/JSaml json methods
                    // It can be undefined eg if the popup fails to open
                    this.automaticLoginPromise &#x3D; undefined;
                    return result ? Promise.resolve() : Promise.reject(&quot;popup failed?&quot;);
                })
                .catch((reason) &#x3D;&gt; {
                    this.automaticLoginPromise &#x3D; undefined;
                    const error &#x3D; new SqError(SqErrorCode.autoLoginError);
                    if (firstCaller) {
                        this.notificationsService.error(error.message);
                    }
                    throw error;
                });
        }
        const credentials: Credentials &#x3D; {};
        if (this.authenticationService.processedCredentials) {
            credentials.userName &#x3D; this.authenticationService.processedCredentials.userName;
        }
        if (!this.loginModalPromise) {
            this.loginModalPromise &#x3D; this.modalService.open(this.loginModal, {model: credentials});
            firstCaller &#x3D; true;
        }
        return this.loginModalPromise
            .then((result) &#x3D;&gt; {
                this.loginModalPromise &#x3D; undefined;
                // result &#x3D;&#x3D;&#x3D; ModalResult.Yes is a special return from Login when using AuthenticationService.authenticateWithProvider
                if (result &#x3D;&#x3D;&#x3D; ModalResult.OK || result &#x3D;&#x3D;&#x3D; ModalResult.Yes) {
                    if (!this.processCredentialsPromise) {
                        this.processCredentialsPromise &#x3D; result &#x3D;&#x3D;&#x3D; ModalResult.Yes ?
                            Promise.resolve&lt;ProcessedCredentials | undefined&gt;(undefined) :
                            this.authenticationService.authenticate(credentials, response);
                    }
                    return this.processCredentialsPromise
                        .then((value) &#x3D;&gt; {
                            this.processCredentialsPromise &#x3D; undefined;
                            if (result !&#x3D;&#x3D; ModalResult.Yes) {
                                this.authenticationService.processedCredentials &#x3D; value;
                            }
                            if (!this.checkPrincipalPromise) {
                                this.checkPrincipalPromise &#x3D; this.principalService.get(false).toPromise();
                            }
                            return this.checkPrincipalPromise
                                .then((principal) &#x3D;&gt; {
                                    this.checkPrincipalPromise &#x3D; undefined;
                                    if (!this.principalService.principal || this.principalService.principal.id &#x3D;&#x3D;&#x3D; principal.id) {
                                        // no current principal OR prinicpal unchanged - initiate retry
                                        return Promise.resolve();
                                    }
                                    const error &#x3D; new SqError(SqErrorCode.principalSwitched);
                                    if (firstCaller) {
                                        this.switchPrincipal(principal);
                                        this.notificationsService.info(error.message);
                                    }
                                    throw error;
                                })
                                .catch((reason) &#x3D;&gt; {
                                    this.checkPrincipalPromise &#x3D; undefined;
                                    throw reason;
                                });
                        })
                        .catch((reason) &#x3D;&gt; {
                            this.processCredentialsPromise &#x3D; undefined;
                            if (SqError.is(reason, SqErrorCode.principalSwitched)) {
                                throw reason;
                            }
                            throw new SqError(SqErrorCode.processedCredentialsError);
                        });
                }
                else {
                    this.authenticationService.processedCredentials &#x3D; undefined; // clean slate
                    const error &#x3D; new SqError(SqErrorCode.loginCancelled);
                    if (firstCaller) {
                        this.notificationsService.info(error.message);
                    }
                    throw error;
                }
            })
            .catch((reason) &#x3D;&gt; {
                if (!SqError.is(reason, SqErrorCode.principalSwitched)) {
                    this.authenticationService.processedCredentials &#x3D; undefined; // clean slate
                }
                this.loginModalPromise &#x3D; undefined;
                throw reason;
            });
    }
}
</code></pre>
    </div>

</div>







                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'LoginService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
