import { Injectable, InjectionToken, Inject } from "@angular/core";
import { Subject } from "rxjs";
import { Action } from "@sinequa/components/action";
import * as i0 from "@angular/core";
import * as i1 from "@sinequa/components/search";
export var SelectionEventType;
(function (SelectionEventType) {
    SelectionEventType[SelectionEventType["SELECT"] = 0] = "SELECT";
    SelectionEventType[SelectionEventType["UNSELECT"] = 1] = "UNSELECT";
    SelectionEventType[SelectionEventType["MOVE"] = 2] = "MOVE";
})(SelectionEventType || (SelectionEventType = {}));
export const defaultSelectionOptions = {
    resetOnNewResults: false,
    resetOnNewQuery: true,
    storage: "id"
};
export const SELECTION_OPTIONS = new InjectionToken("SELECTION_OPTIONS");
export class SelectionService {
    constructor(searchService, selectionOptions) {
        this.searchService = searchService;
        this.selectionOptions = selectionOptions;
        this.selectedRecords = []; // currently selected items
        this.selectionActions = []; // Actions that other services can register onto this service
        this._events = new Subject();
        this.searchService.events.subscribe(event => {
            var _a;
            if (!this.selectionOptions.resetOnNewResults && event.type === "new-results" && this.searchService.haveRecords) {
                const newSelectedRecords = [];
                if ((_a = this.searchService.results) === null || _a === void 0 ? void 0 : _a.records) {
                    for (const record of this.searchService.results.records) {
                        const index = this.selectedRecords.findIndex(item => item.id === record.id);
                        if (index !== -1 && !record.$selected) {
                            record.$selected = true; // Select previously selected records
                            this.selectedRecords.splice(index, 1, record);
                            newSelectedRecords.push(record);
                        }
                    }
                }
                if (newSelectedRecords.length > 0) // Menus might need to be refreshed
                    this._events.next({ type: SelectionEventType.SELECT, records: newSelectedRecords, source: event.type });
            }
            if (this.selectionOptions.resetOnNewResults && event.type === "new-results") {
                this.clearSelectedRecords(event.type);
            }
            if (this.selectionOptions.resetOnNewQuery && event.type === "new-query") {
                this.clearSelectedRecords(event.type);
            }
        });
        this.selectedRecordsAction = this.buildSelectRecordsAction();
        this.selectionActions.push(this.selectedRecordsAction);
        this.events.subscribe({ next: () => {
                this.selectionActions.forEach(action => action.update());
            } });
    }
    /**
     * Emits an event on any (bulk or single) selection and unselection events
     */
    get events() {
        return this._events;
    }
    ngOnDestroy() {
        this._events.complete();
    }
    getItem(record) {
        if (this.selectionOptions.storage === "id") {
            return { id: record.id };
        }
        else if (this.selectionOptions.storage === "record") {
            return record;
        }
        else {
            return this.selectionOptions.storage(record);
        }
    }
    /**
     * Returns a copy of the list of selected records
     */
    getSelectedItems() {
        return this.selectedRecords.slice(0);
    }
    /**
     * Return the list of selected record ids
     */
    getSelectedIds() {
        return this.selectedRecords.map(r => r.id);
    }
    /**
     * @returns true if at least one record is selected
     */
    get haveSelectedRecords() {
        return this.selectedRecords.length > 0;
    }
    getSelectedCount() {
        return this.selectedRecords.length;
    }
    /**
     * @returns true if all records in the search results are selected
     */
    get allRecordsSelected() {
        if (!this.searchService.results || !this.searchService.results.records) {
            return false;
        }
        for (const record of this.searchService.results.records) {
            if (!record.$selected) {
                return false;
            }
        }
        return true;
    }
    selectCurrentRecords(source) {
        const newSelectedRecords = [];
        if (this.searchService.results && this.searchService.results.records) {
            for (const record of this.searchService.results.records) {
                if (!record.$selected) {
                    this.selectedRecords.push(this.getItem(record));
                    newSelectedRecords.push(record);
                    record.$selected = true;
                }
            }
        }
        if (newSelectedRecords.length > 0)
            this._events.next({ type: SelectionEventType.SELECT, records: newSelectedRecords, source });
    }
    /**
     * Toggles the selection of one record or all those in the results.
     * Emits a SelectionEvent if a record is selected or unselected.
     * @param record if provided, will toggle the selection of this record; if not will toggle all records in results
     */
    toggleSelectedRecords(record, source) {
        if (!!record) {
            const index = this.selectedRecords.findIndex(item => item.id === record.id);
            if (index > -1) {
                this.selectedRecords.splice(index, 1);
                record.$selected = false;
            }
            else {
                this.selectedRecords.push(this.getItem(record));
                record.$selected = true;
            }
            // record might not be the one in the search service results (if passing a SelectionItem)
            const ssRecord = this.searchService.getRecordFromId(record.id);
            if (ssRecord) {
                ssRecord.$selected = record.$selected;
            }
            this._events.next({ type: record.$selected ? SelectionEventType.UNSELECT : SelectionEventType.SELECT, records: [record], source });
        }
        else {
            if (this.allRecordsSelected) {
                this.clearSelectedRecords(source);
            }
            else {
                this.selectCurrentRecords(source);
            }
        }
    }
    /**
     * Moves a selected record to a different index;
     * @param record
     * @param newIndex
     */
    moveSelectedRecord(record, newIndex, source) {
        const i = this.selectedRecords.findIndex(r => r.id === record.id);
        if (i === -1) {
            throw new Error(`Record ${record.id} is not in the selected records`);
        }
        this.selectedRecords.splice(i, 1);
        this.selectedRecords.splice(newIndex, 0, this.getItem(record));
        this.events.next({ type: SelectionEventType.MOVE, records: [record], source });
    }
    /**
     * Unselect all selected records
     * Emits a SelectionEvent
     */
    clearSelectedRecords(source) {
        this.selectedRecords.splice(0);
        const newUnselectedRecords = [];
        if (this.searchService.results && this.searchService.results.records) {
            for (const record of this.searchService.results.records) {
                if (record.$selected) {
                    record.$selected = false;
                    newUnselectedRecords.push(record);
                }
            }
        }
        if (newUnselectedRecords.length > 0)
            this._events.next({ type: SelectionEventType.UNSELECT, records: newUnselectedRecords, source });
    }
    buildSelectRecordsAction() {
        return new Action({
            icon: "far fa-square",
            text: "msg#resultsSelector.selectDocuments",
            title: this.allRecordsSelected ? "msg#resultsSelector.unselectDocumentsTitle" : "msg#resultsSelector.selectDocumentsTitle",
            messageParams: { values: { count: this.selectedRecords.length } },
            action: (item, $event) => {
                this.toggleSelectedRecords(undefined, "multiple-selector");
            },
            updater: (item) => {
                item.icon = this.haveSelectedRecords ? "far fa-check-square" : "far fa-square";
                item.title = this.allRecordsSelected ? "msg#resultsSelector.unselectDocumentsTitle" : "msg#resultsSelector.selectDocumentsTitle";
                item.messageParams = { values: { count: this.selectedRecords.length } };
            }
        });
    }
}
SelectionService.ɵfac = function SelectionService_Factory(t) { return new (t || SelectionService)(i0.ɵɵinject(i1.SearchService), i0.ɵɵinject(SELECTION_OPTIONS)); };
SelectionService.ɵprov = i0.ɵɵdefineInjectable({ token: SelectionService, factory: SelectionService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(SelectionService, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], function () { return [{ type: i1.SearchService }, { type: undefined, decorators: [{
                type: Inject,
                args: [SELECTION_OPTIONS]
            }] }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vcHJvamVjdHMvY29tcG9uZW50cy9zZWxlY3Rpb24vIiwic291cmNlcyI6WyJzZWxlY3Rpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFhLGNBQWMsRUFBRSxNQUFNLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDNUUsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUU3QixPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7OztBQUdsRCxNQUFNLENBQU4sSUFBWSxrQkFJWDtBQUpELFdBQVksa0JBQWtCO0lBQzFCLCtEQUFNLENBQUE7SUFDTixtRUFBUSxDQUFBO0lBQ1IsMkRBQUksQ0FBQTtBQUNSLENBQUMsRUFKVyxrQkFBa0IsS0FBbEIsa0JBQWtCLFFBSTdCO0FBeUJELE1BQU0sQ0FBQyxNQUFNLHVCQUF1QixHQUFxQjtJQUNyRCxpQkFBaUIsRUFBRSxLQUFLO0lBQ3hCLGVBQWUsRUFBRSxJQUFJO0lBQ3JCLE9BQU8sRUFBRSxJQUFJO0NBQ2hCLENBQUE7QUFFRCxNQUFNLENBQUMsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLGNBQWMsQ0FBbUIsbUJBQW1CLENBQUMsQ0FBQztBQUszRixNQUFNLE9BQU8sZ0JBQWdCO0lBU3pCLFlBQ1csYUFBNkIsRUFDRixnQkFBa0M7UUFEN0Qsa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBQ0YscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQVRyRCxvQkFBZSxHQUFvQixFQUFFLENBQUMsQ0FBQywyQkFBMkI7UUFDckUscUJBQWdCLEdBQWEsRUFBRSxDQUFDLENBQUMsNkRBQTZEO1FBRXRHLFlBQU8sR0FBRyxJQUFJLE9BQU8sRUFBa0IsQ0FBQztRQVM1QyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVB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LEVBQUM7WUFDN0QsTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxFQUFFO2dCQUNyQixJQUFJLENBQUMscUJBQXFCLENBQUMsU0FBUyxFQUFFLG1CQUFtQixDQUFDLENBQUM7WUFDL0QsQ0FBQztZQUNELE9BQU8sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUNkLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDO2dCQUMvRSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsNENBQTRDLENBQUMsQ0FBQyxDQUFDLDBDQUEwQyxDQUFDO2dCQUNqSSxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUMsTUFBTSxFQUFFLEVBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFDLEVBQUMsQ0FBQztZQUN4RSxDQUFDO1NBQ0osQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7Z0ZBdE5RLGdCQUFnQiw2Q0FXYixpQkFBaUI7d0RBWHBCLGdCQUFnQixXQUFoQixnQkFBZ0IsbUJBRmIsTUFBTTtrREFFVCxnQkFBZ0I7Y0FINUIsVUFBVTtlQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOztzQkFZUSxNQUFNO3VCQUFDLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZSwgT25EZXN0cm95LCBJbmplY3Rpb25Ub2tlbiwgSW5qZWN0fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHtTdWJqZWN0fSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHtSZWNvcmR9IGZyb20gXCJAc2luZXF1YS9jb3JlL3dlYi1zZXJ2aWNlc1wiO1xuaW1wb3J0IHtBY3Rpb259IGZyb20gXCJAc2luZXF1YS9jb21wb25lbnRzL2FjdGlvblwiO1xuaW1wb3J0IHtTZWFyY2hTZXJ2aWNlfSBmcm9tIFwiQHNpbmVxdWEvY29tcG9uZW50cy9zZWFyY2hcIjtcblxuZXhwb3J0IGVudW0gU2VsZWN0aW9uRXZlbnRUeXBlIHtcbiAgICBTRUxFQ1QsXG4gICAgVU5TRUxFQ1QsXG4gICAgTU9WRVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNlbGVjdGlvbkV2ZW50IHtcbiAgICB0eXBlOiBTZWxlY3Rpb25FdmVudFR5cGU7XG4gICAgcmVjb3JkczogUmVjb3JkW107XG4gICAgc291cmNlPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNlbGVjdGlvbkl0ZW0ge1xuICAgIGlkOiBzdHJpbmc7XG59XG5cbi8qKlxuICogVGhlIHN0b3JhZ2UgbW9kZSBhbGxvd3MgdG8gY3VzdG9taXplIGhvdyB0aGUgc2VydmljZSBzdG9yZXMgcmVjb3JkcywgXG4gKiB3aGljaCBlbmFibGVzIGRpZmZlcmVudCBmZWF0dXJlczpcbiAqIC0gaWQ6IG9ubHkgc3RvcmUgdGhlIGlkIG9mIGEgc2VsZWN0ZWQgcmVjb3JkIChkZWZhdWx0KVxuICogLSByZWNvcmQ6IHN0b3JlIHRoZSBlbnRpcmUgcmVjb3JkXG4gKiAtIGEgZnVuY3Rpb24gdGhhdCBjdXN0b21pemUgd2hhdCBpcyBzdG9yZWQgKGF0IGxlYXN0IHRoZSByZWNvcmQgaWQgaXMgcmVxdWlyZWQpXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU2VsZWN0aW9uT3B0aW9ucyB7XG4gICAgcmVzZXRPbk5ld1Jlc3VsdHM6IGJvb2xlYW47XG4gICAgcmVzZXRPbk5ld1F1ZXJ5OiBib29sZWFuO1xuICAgIHN0b3JhZ2U6IFwiaWRcIiB8IFwicmVjb3JkXCIgfCAoKHJlY29yZDogUmVjb3JkKSA9PiBTZWxlY3Rpb25JdGVtKTtcbn1cblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRTZWxlY3Rpb25PcHRpb25zOiBTZWxlY3Rpb25PcHRpb25zID0ge1xuICAgIHJlc2V0T25OZXdSZXN1bHRzOiBmYWxzZSxcbiAgICByZXNldE9uTmV3UXVlcnk6IHRydWUsXG4gICAgc3RvcmFnZTogXCJpZFwiXG59XG5cbmV4cG9ydCBjb25zdCBTRUxFQ1RJT05fT1BUSU9OUyA9IG5ldyBJbmplY3Rpb25Ub2tlbjxTZWxlY3Rpb25PcHRpb25zPihcIlNFTEVDVElPTl9PUFRJT05TXCIpO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBTZWxlY3Rpb25TZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcblxuICAgIHByb3RlY3RlZCByZWFkb25seSBzZWxlY3RlZFJlY29yZHM6IFNlbGVjdGlvbkl0ZW1bXSA9IFtdOyAvLyBjdXJyZW50bHkgc2VsZWN0ZWQgaXRlbXNcbiAgICBwdWJsaWMgcmVhZG9ubHkgc2VsZWN0aW9uQWN0aW9uczogQWN0aW9uW10gPSBbXTsgLy8gQWN0aW9ucyB0aGF0IG90aGVyIHNlcnZpY2VzIGNhbiByZWdpc3RlciBvbnRvIHRoaXMgc2VydmljZVxuXG4gICAgcHJpdmF0ZSBfZXZlbnRzID0gbmV3IFN1YmplY3Q8U2VsZWN0aW9uRXZlbnQ+KCk7XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgc2VsZWN0ZWRSZWNvcmRzQWN0aW9uOiBBY3Rpb247XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHVibGljIHNlYXJjaFNlcnZpY2UgOiBTZWFyY2hTZXJ2aWNlLFxuICAgICAgICBASW5qZWN0KFNFTEVDVElPTl9PUFRJT05TKSBwdWJsaWMgc2VsZWN0aW9uT3B0aW9uczogU2VsZWN0aW9uT3B0aW9ucyBcbiAgICApe1xuXG4gICAgICAgIHRoaXMuc2VhcmNoU2VydmljZS5ldmVudHMuc3Vic2NyaWJlKGV2ZW50ID0+IHtcblxuICAgICAgICAgICAgaWYoIXRoaXMuc2VsZWN0aW9uT3B0aW9ucy5yZXNldE9uTmV3UmVzdWx0cyAmJiBldmVudC50eXBlID09PSBcIm5ldy1yZXN1bHRzXCIgJiYgdGhpcy5zZWFyY2hTZXJ2aWNlLmhhdmVSZWNvcmRzKXtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld1NlbGVjdGVkUmVjb3JkczogUmVjb3JkW10gPSBbXTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zZWFyY2hTZXJ2aWNlLnJlc3VsdHM/LnJlY29yZHMpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5zZWFyY2hTZXJ2aWNlLnJlc3VsdHMucmVjb3Jkcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNlbGVjdGVkUmVjb3Jkcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtLmlkID09PSByZWNvcmQuaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSAmJiAhcmVjb3JkLiRzZWxlY3RlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZC4kc2VsZWN0ZWQgPSB0cnVlOyAgICAvLyBTZWxlY3QgcHJldmlvdXNseSBzZWxlY3RlZCByZWNvcmRzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFJlY29yZHMuc3BsaWNlKGluZGV4LCAxLCByZWNvcmQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1NlbGVjdGVkUmVjb3Jkcy5wdXNoKHJlY29yZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYobmV3U2VsZWN0ZWRSZWNvcmRzLmxlbmd0aCA+IDApICAgLy8gTWVudXMgbWlnaHQgbmVlZCB0byBiZSByZWZyZXNoZWRcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZlbnRzLm5leHQoe3R5cGU6IFNlbGVjdGlvbkV2ZW50VHlwZS5TRUxFQ1QsIHJlY29yZHM6IG5ld1NlbGVjdGVkUmVjb3Jkcywgc291cmNlOiBldmVudC50eXBlfSk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYodGhpcy5zZWxlY3Rpb25PcHRpb25zLnJlc2V0T25OZXdSZXN1bHRzICYmIGV2ZW50LnR5cGUgPT09IFwibmV3LXJlc3VsdHNcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJTZWxlY3RlZFJlY29yZHMoZXZlbnQudHlwZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmKHRoaXMuc2VsZWN0aW9uT3B0aW9ucy5yZXNldE9uTmV3UXVlcnkgJiYgZXZlbnQudHlwZSA9PT0gXCJuZXctcXVlcnlcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJTZWxlY3RlZFJlY29yZHMoZXZlbnQudHlwZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zZWxlY3RlZFJlY29yZHNBY3Rpb24gPSB0aGlzLmJ1aWxkU2VsZWN0UmVjb3Jkc0FjdGlvbigpO1xuICAgICAgICB0aGlzLnNlbGVjdGlvbkFjdGlvbnMucHVzaCh0aGlzLnNlbGVjdGVkUmVjb3Jkc0FjdGlvbik7XG5cbiAgICAgICAgdGhpcy5ldmVudHMuc3Vic2NyaWJlKHtuZXh0OiAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGlvbkFjdGlvbnMuZm9yRWFjaChhY3Rpb24gPT4gYWN0aW9uLnVwZGF0ZSgpKTtcbiAgICAgICAgfX0pO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRW1pdHMgYW4gZXZlbnQgb24gYW55IChidWxrIG9yIHNpbmdsZSkgc2VsZWN0aW9uIGFuZCB1bnNlbGVjdGlvbiBldmVudHNcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0IGV2ZW50cygpIDogU3ViamVjdDxTZWxlY3Rpb25FdmVudD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXZlbnRzO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCl7XG4gICAgICAgIHRoaXMuX2V2ZW50cy5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0SXRlbShyZWNvcmQ6IFJlY29yZCk6IFNlbGVjdGlvbkl0ZW0ge1xuICAgICAgICBpZih0aGlzLnNlbGVjdGlvbk9wdGlvbnMuc3RvcmFnZSA9PT0gXCJpZFwiKSB7XG4gICAgICAgICAgICByZXR1cm4ge2lkOiByZWNvcmQuaWR9O1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYodGhpcy5zZWxlY3Rpb25PcHRpb25zLnN0b3JhZ2UgPT09IFwicmVjb3JkXCIpIHtcbiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Rpb25PcHRpb25zLnN0b3JhZ2UocmVjb3JkKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgYSBjb3B5IG9mIHRoZSBsaXN0IG9mIHNlbGVjdGVkIHJlY29yZHNcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0U2VsZWN0ZWRJdGVtcygpOiBTZWxlY3Rpb25JdGVtW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZFJlY29yZHMuc2xpY2UoMCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIHRoZSBsaXN0IG9mIHNlbGVjdGVkIHJlY29yZCBpZHNcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0U2VsZWN0ZWRJZHMoKTogc3RyaW5nW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZFJlY29yZHMubWFwKHIgPT4gci5pZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHJldHVybnMgdHJ1ZSBpZiBhdCBsZWFzdCBvbmUgcmVjb3JkIGlzIHNlbGVjdGVkXG4gICAgICovXG4gICAgcHVibGljIGdldCBoYXZlU2VsZWN0ZWRSZWNvcmRzKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZFJlY29yZHMubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0U2VsZWN0ZWRDb3VudCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZFJlY29yZHMubGVuZ3RoO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm5zIHRydWUgaWYgYWxsIHJlY29yZHMgaW4gdGhlIHNlYXJjaCByZXN1bHRzIGFyZSBzZWxlY3RlZFxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgYWxsUmVjb3Jkc1NlbGVjdGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoIXRoaXMuc2VhcmNoU2VydmljZS5yZXN1bHRzIHx8ICF0aGlzLnNlYXJjaFNlcnZpY2UucmVzdWx0cy5yZWNvcmRzKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5zZWFyY2hTZXJ2aWNlLnJlc3VsdHMucmVjb3Jkcykge1xuICAgICAgICAgICAgaWYgKCFyZWNvcmQuJHNlbGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2VsZWN0Q3VycmVudFJlY29yZHMoc291cmNlPzogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IG5ld1NlbGVjdGVkUmVjb3JkczogUmVjb3JkW10gPSBbXTtcbiAgICAgICAgaWYgKHRoaXMuc2VhcmNoU2VydmljZS5yZXN1bHRzICYmIHRoaXMuc2VhcmNoU2VydmljZS5yZXN1bHRzLnJlY29yZHMpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIHRoaXMuc2VhcmNoU2VydmljZS5yZXN1bHRzLnJlY29yZHMpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXJlY29yZC4kc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFJlY29yZHMucHVzaCh0aGlzLmdldEl0ZW0ocmVjb3JkKSk7XG4gICAgICAgICAgICAgICAgICAgIG5ld1NlbGVjdGVkUmVjb3Jkcy5wdXNoKHJlY29yZCk7XG4gICAgICAgICAgICAgICAgICAgIHJlY29yZC4kc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZihuZXdTZWxlY3RlZFJlY29yZHMubGVuZ3RoID4gMClcbiAgICAgICAgICAgIHRoaXMuX2V2ZW50cy5uZXh0KHt0eXBlOiBTZWxlY3Rpb25FdmVudFR5cGUuU0VMRUNULCByZWNvcmRzOiBuZXdTZWxlY3RlZFJlY29yZHMsIHNvdXJjZX0pO1xuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICogVG9nZ2xlcyB0aGUgc2VsZWN0aW9uIG9mIG9uZSByZWNvcmQgb3IgYWxsIHRob3NlIGluIHRoZSByZXN1bHRzLlxuICAgICAqIEVtaXRzIGEgU2VsZWN0aW9uRXZlbnQgaWYgYSByZWNvcmQgaXMgc2VsZWN0ZWQgb3IgdW5zZWxlY3RlZC5cbiAgICAgKiBAcGFyYW0gcmVjb3JkIGlmIHByb3ZpZGVkLCB3aWxsIHRvZ2dsZSB0aGUgc2VsZWN0aW9uIG9mIHRoaXMgcmVjb3JkOyBpZiBub3Qgd2lsbCB0b2dnbGUgYWxsIHJlY29yZHMgaW4gcmVzdWx0c1xuICAgICAqL1xuICAgIHB1YmxpYyB0b2dnbGVTZWxlY3RlZFJlY29yZHMocmVjb3JkPzogUmVjb3JkLCBzb3VyY2U/OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCEhcmVjb3JkKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuc2VsZWN0ZWRSZWNvcmRzLmZpbmRJbmRleChpdGVtID0+IGl0ZW0uaWQgPT09IHJlY29yZC5pZCk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRSZWNvcmRzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgcmVjb3JkLiRzZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFJlY29yZHMucHVzaCh0aGlzLmdldEl0ZW0ocmVjb3JkKSk7XG4gICAgICAgICAgICAgICAgcmVjb3JkLiRzZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyByZWNvcmQgbWlnaHQgbm90IGJlIHRoZSBvbmUgaW4gdGhlIHNlYXJjaCBzZXJ2aWNlIHJlc3VsdHMgKGlmIHBhc3NpbmcgYSBTZWxlY3Rpb25JdGVtKVxuICAgICAgICAgICAgY29uc3Qgc3NSZWNvcmQgPSB0aGlzLnNlYXJjaFNlcnZpY2UuZ2V0UmVjb3JkRnJvbUlkKHJlY29yZC5pZCk7XG4gICAgICAgICAgICBpZihzc1JlY29yZCkge1xuICAgICAgICAgICAgICAgIHNzUmVjb3JkLiRzZWxlY3RlZCA9IHJlY29yZC4kc2VsZWN0ZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl9ldmVudHMubmV4dCh7dHlwZTogcmVjb3JkLiRzZWxlY3RlZD8gU2VsZWN0aW9uRXZlbnRUeXBlLlVOU0VMRUNUIDogU2VsZWN0aW9uRXZlbnRUeXBlLlNFTEVDVCwgcmVjb3JkczogW3JlY29yZF0sIHNvdXJjZX0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMuYWxsUmVjb3Jkc1NlbGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jbGVhclNlbGVjdGVkUmVjb3Jkcyhzb3VyY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RDdXJyZW50UmVjb3Jkcyhzb3VyY2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTW92ZXMgYSBzZWxlY3RlZCByZWNvcmQgdG8gYSBkaWZmZXJlbnQgaW5kZXg7XG4gICAgICogQHBhcmFtIHJlY29yZCBcbiAgICAgKiBAcGFyYW0gbmV3SW5kZXggXG4gICAgICovXG4gICAgcHVibGljIG1vdmVTZWxlY3RlZFJlY29yZChyZWNvcmQ6IFJlY29yZCwgbmV3SW5kZXg6IG51bWJlciwgc291cmNlPzogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGkgPSB0aGlzLnNlbGVjdGVkUmVjb3Jkcy5maW5kSW5kZXgociA9PiByLmlkID09PSByZWNvcmQuaWQpO1xuICAgICAgICBpZihpID09PSAtMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWNvcmQgJHtyZWNvcmQuaWR9IGlzIG5vdCBpbiB0aGUgc2VsZWN0ZWQgcmVjb3Jkc2ApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRSZWNvcmRzLnNwbGljZShpLCAxKTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFJlY29yZHMuc3BsaWNlKG5ld0luZGV4LCAwLCB0aGlzLmdldEl0ZW0ocmVjb3JkKSk7XG4gICAgICAgIHRoaXMuZXZlbnRzLm5leHQoe3R5cGU6IFNlbGVjdGlvbkV2ZW50VHlwZS5NT1ZFLCByZWNvcmRzOiBbcmVjb3JkXSwgc291cmNlfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVW5zZWxlY3QgYWxsIHNlbGVjdGVkIHJlY29yZHNcbiAgICAgKiBFbWl0cyBhIFNlbGVjdGlvbkV2ZW50XG4gICAgICovXG4gICAgcHVibGljIGNsZWFyU2VsZWN0ZWRSZWNvcmRzKHNvdXJjZT86IHN0cmluZykge1xuICAgICAgICB0aGlzLnNlbGVjdGVkUmVjb3Jkcy5zcGxpY2UoMCk7XG4gICAgICAgIGNvbnN0IG5ld1Vuc2VsZWN0ZWRSZWNvcmRzOiBSZWNvcmRbXSA9IFtdO1xuICAgICAgICBpZiAodGhpcy5zZWFyY2hTZXJ2aWNlLnJlc3VsdHMgJiYgdGhpcy5zZWFyY2hTZXJ2aWNlLnJlc3VsdHMucmVjb3Jkcykge1xuICAgICAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgdGhpcy5zZWFyY2hTZXJ2aWNlLnJlc3VsdHMucmVjb3Jkcykge1xuICAgICAgICAgICAgICAgIGlmKHJlY29yZC4kc2VsZWN0ZWQpe1xuICAgICAgICAgICAgICAgICAgICByZWNvcmQuJHNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIG5ld1Vuc2VsZWN0ZWRSZWNvcmRzLnB1c2gocmVjb3JkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYobmV3VW5zZWxlY3RlZFJlY29yZHMubGVuZ3RoID4gMClcbiAgICAgICAgICAgIHRoaXMuX2V2ZW50cy5uZXh0KHt0eXBlOiBTZWxlY3Rpb25FdmVudFR5cGUuVU5TRUxFQ1QsIHJlY29yZHM6IG5ld1Vuc2VsZWN0ZWRSZWNvcmRzLCBzb3VyY2V9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkU2VsZWN0UmVjb3Jkc0FjdGlvbigpOiBBY3Rpb24ge1xuICAgICAgICByZXR1cm4gbmV3IEFjdGlvbih7XG4gICAgICAgICAgICBpY29uOiBcImZhciBmYS1zcXVhcmVcIixcbiAgICAgICAgICAgIHRleHQ6IFwibXNnI3Jlc3VsdHNTZWxlY3Rvci5zZWxlY3REb2N1bWVudHNcIixcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLmFsbFJlY29yZHNTZWxlY3RlZCA/IFwibXNnI3Jlc3VsdHNTZWxlY3Rvci51bnNlbGVjdERvY3VtZW50c1RpdGxlXCIgOiBcIm1zZyNyZXN1bHRzU2VsZWN0b3Iuc2VsZWN0RG9jdW1lbnRzVGl0bGVcIixcbiAgICAgICAgICAgIG1lc3NhZ2VQYXJhbXM6IHt2YWx1ZXM6IHtjb3VudDogdGhpcy5zZWxlY3RlZFJlY29yZHMubGVuZ3RofX0sXG4gICAgICAgICAgICBhY3Rpb246IChpdGVtLCAkZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZVNlbGVjdGVkUmVjb3Jkcyh1bmRlZmluZWQsIFwibXVsdGlwbGUtc2VsZWN0b3JcIik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdXBkYXRlcjogKGl0ZW0pID0+IHtcbiAgICAgICAgICAgICAgICBpdGVtLmljb24gPSB0aGlzLmhhdmVTZWxlY3RlZFJlY29yZHMgPyBcImZhciBmYS1jaGVjay1zcXVhcmVcIiA6IFwiZmFyIGZhLXNxdWFyZVwiO1xuICAgICAgICAgICAgICAgIGl0ZW0udGl0bGUgPSB0aGlzLmFsbFJlY29yZHNTZWxlY3RlZCA/IFwibXNnI3Jlc3VsdHNTZWxlY3Rvci51bnNlbGVjdERvY3VtZW50c1RpdGxlXCIgOiBcIm1zZyNyZXN1bHRzU2VsZWN0b3Iuc2VsZWN0RG9jdW1lbnRzVGl0bGVcIjtcbiAgICAgICAgICAgICAgICBpdGVtLm1lc3NhZ2VQYXJhbXMgPSB7dmFsdWVzOiB7Y291bnQ6IHRoaXMuc2VsZWN0ZWRSZWNvcmRzLmxlbmd0aH19O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59Il19