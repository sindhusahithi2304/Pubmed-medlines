import { Injectable } from "@angular/core";
import { Subject } from "rxjs";
import { Keys } from "@sinequa/core/base";
import * as i0 from "@angular/core";
export const gClassName = {
    DISABLED: 'disabled',
    SHOW: 'show',
    DROPUP: 'dropup',
    DROPRIGHT: 'dropright',
    DROPLEFT: 'dropleft',
    MENURIGHT: 'dropdown-menu-right',
    MENULEFT: 'dropdown-menu-left',
    POSITION_STATIC: 'position-static'
};
export const gSelector = {
    DROPDOWN: '.dropdown',
    DATA_TOGGLE: '[data-toggle="dropdown"]',
    FORM_CHILD: '.dropdown form',
    MENU: '.dropdown-menu',
    NAVBAR_NAV: '.navbar-nav',
    VISIBLE_ITEMS: '.dropdown-menu .dropdown-item:not(.disabled):not(:disabled)'
};
export const gAttachmentMap = {
    TOP: 'top-start',
    TOPEND: 'top-end',
    BOTTOM: 'bottom-start',
    BOTTOMEND: 'bottom-end',
    RIGHT: 'right-start',
    RIGHTEND: 'right-end',
    LEFT: 'left-start',
    LEFTEND: 'left-end'
};
export class BsDropdownService {
    constructor(rendererFactory) {
        this.dataApiKeydownHandler = (event) => {
            const descendant = this.matchDescendant(document.documentElement, event, `${gSelector.DATA_TOGGLE},${gSelector.MENU}`);
            if (!descendant) {
                return;
            }
            // If not input/textarea:
            //  - And not a key in REGEXP_KEYDOWN => not a dropdown command
            // If input/textarea:
            //  - If space key => not a dropdown command
            //  - If key is other than escape
            //    - If key is not up or down => not a dropdown command
            //    - If trigger inside the menu => not a dropdown command
            if (/input|textarea/i.test(event.target.tagName) ?
                event.which === Keys.space || event.which !== Keys.esc &&
                    (event.which !== Keys.down && event.which !== Keys.up || event.target.closest(gSelector.MENU)) :
                !(event.which === Keys.up || event.which === Keys.down || event.which === Keys.esc)) {
                return;
            }
            event.preventDefault();
            event.stopPropagation();
            if ( /*TODO descendant.disabled || */descendant.classList.contains(gClassName.DISABLED)) {
                return;
            }
            const parent = this.getParentFromElement(descendant);
            const isActive = parent instanceof HTMLElement && parent.classList.contains(gClassName.SHOW);
            if (!isActive && event.which === Keys.esc) {
                return;
            }
            if (!isActive || isActive && (event.which === Keys.esc || event.which === Keys.space)) {
                if (event.which === Keys.esc) {
                    const toggle = parent instanceof Element && parent.querySelector(gSelector.DATA_TOGGLE);
                    if (toggle instanceof HTMLElement) {
                        // toggle.dispatchEvent(new Event("focus", {bubbles: true}));
                        // NB $(toggle).trigger('focus') will set the focus on toggle
                        toggle.focus();
                    }
                }
                descendant.dispatchEvent(new Event("click", { bubbles: true }));
                return;
            }
            let items = [];
            if (parent instanceof Element) {
                items = items.slice.call(parent.querySelectorAll(gSelector.VISIBLE_ITEMS))
                    .filter((item) => item instanceof HTMLElement && (item.offsetWidth > 0 || item.offsetHeight > 0));
            }
            if (items.length === 0) {
                return;
            }
            let index = items.indexOf(event.target);
            if (event.which === Keys.up && index > 0) { // Up
                index--;
            }
            if (event.which === Keys.down && index < items.length - 1) { // Down
                index++;
            }
            if (index < 0) {
                index = 0;
            }
            items[index].focus();
        };
        this.clearMenus = (event) => {
            if (event && (event.which === 3 /*RIGHT_MOUSE_BUTTON_WHICH*/ ||
                event.type === 'keyup' && event.which !== Keys.tab)) {
                return;
            }
            this._events.next({ type: "clear", sourceEvent: event });
        };
        this.toggle = (event) => {
            const descendant = this.matchDescendant(document.documentElement, event, gSelector.DATA_TOGGLE);
            if (!descendant) {
                return;
            }
            event.preventDefault();
            event.stopPropagation();
            this._events.next({ type: "toggle", element: descendant });
        };
        this.formChildClick = (event) => {
            if (!this.matchDescendant(document.documentElement, event, gSelector.FORM_CHILD)) {
                return;
            }
            event.stopPropagation();
        };
        this._events = new Subject();
        this.renderer = rendererFactory.createRenderer(null, null);
        this.unlisteners = [];
        this.unlisteners.push(this.renderer.listen(document, "keydown", this.dataApiKeydownHandler));
        this.unlisteners.push(this.renderer.listen(document, "click", this.clearMenus));
        this.unlisteners.push(this.renderer.listen(document, "keyup", this.clearMenus));
        this.unlisteners.push(this.renderer.listen(document, "click", this.toggle));
        this.unlisteners.push(this.renderer.listen(document, "click", this.formChildClick));
    }
    ngOnDestroy() {
        this._events.complete();
        this.unlisteners.forEach((unlistener) => unlistener());
    }
    get events() {
        return this._events;
    }
    matchDescendant(base, event, selector) {
        let element = event.target;
        while (element && element !== base) {
            if (element.matches(selector)) {
                return element;
            }
            element = element.parentElement;
        }
        return null;
    }
    getSelectorFromElement(element) {
        let selector = element.getAttribute('data-target');
        if (!selector || selector === '#') {
            const hrefAttr = element.getAttribute('href');
            selector = hrefAttr && hrefAttr !== '#' ? hrefAttr.trim() : '';
        }
        try {
            return document.querySelector(selector) ? selector : null;
        }
        catch (err) {
            return null;
        }
    }
    getParentFromElement(element) {
        let parent = null;
        const selector = this.getSelectorFromElement(element);
        if (selector) {
            parent = document.querySelector(selector);
        }
        if (!parent) {
            // Account for scroll menus and sub menus
            parent = element.parentElement;
            while (parent &&
                (parent.classList.contains("sq-scroll-menu") ||
                    parent.classList.contains("sq-scroll-menu-item") ||
                    parent.classList.contains("dropdown-submenu"))) {
                parent = parent.parentElement;
            }
        }
        return parent;
    }
    raiseClear() {
        this._events.next({ type: "clear", sourceEvent: undefined });
    }
}
BsDropdownService.ɵfac = function BsDropdownService_Factory(t) { return new (t || BsDropdownService)(i0.ɵɵinject(i0.RendererFactory2)); };
BsDropdownService.ɵprov = i0.ɵɵdefineInjectable({ token: BsDropdownService, factory: BsDropdownService.ɵfac, providedIn: "root" });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(BsDropdownService, [{
        type: Injectable,
        args: [{
                providedIn: "root"
            }]
    }], function () { return [{ type: i0.RendererFactory2 }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLi9wcm9qZWN0cy9jb21wb25lbnRzL2FjdGlvbi8iLCJzb3VyY2VzIjpbImJvb3RzdHJhcC9kcm9wZG93bi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQXlDLE1BQU0sZUFBZSxDQUFDO0FBQ2pGLE9BQU8sRUFBQyxPQUFPLEVBQWEsTUFBTSxNQUFNLENBQUM7QUFDekMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLG9CQUFvQixDQUFDOztBQW9CeEMsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHO0lBQ3RCLFFBQVEsRUFBVSxVQUFVO0lBQzVCLElBQUksRUFBYyxNQUFNO0lBQ3hCLE1BQU0sRUFBWSxRQUFRO0lBQzFCLFNBQVMsRUFBUyxXQUFXO0lBQzdCLFFBQVEsRUFBVSxVQUFVO0lBQzVCLFNBQVMsRUFBUyxxQkFBcUI7SUFDdkMsUUFBUSxFQUFVLG9CQUFvQjtJQUN0QyxlQUFlLEVBQUcsaUJBQWlCO0NBQ3RDLENBQUM7QUFFRixNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUc7SUFDckIsUUFBUSxFQUFRLFdBQVc7SUFDM0IsV0FBVyxFQUFLLDBCQUEwQjtJQUMxQyxVQUFVLEVBQU0sZ0JBQWdCO0lBQ2hDLElBQUksRUFBWSxnQkFBZ0I7SUFDaEMsVUFBVSxFQUFNLGFBQWE7SUFDN0IsYUFBYSxFQUFHLDZEQUE2RDtDQUNoRixDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHO0lBQzFCLEdBQUcsRUFBUyxXQUFXO0lBQ3ZCLE1BQU0sRUFBTSxTQUFTO0lBQ3JCLE1BQU0sRUFBTSxjQUFjO0lBQzFCLFNBQVMsRUFBRyxZQUFZO0lBQ3hCLEtBQUssRUFBTyxhQUFhO0lBQ3pCLFFBQVEsRUFBSSxXQUFXO0lBQ3ZCLElBQUksRUFBUSxZQUFZO0lBQ3hCLE9BQU8sRUFBSyxVQUFVO0NBQ3pCLENBQUM7QUFLRixNQUFN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TUFBTSxDQUFDLGFBQWEsQ0FBQzthQUNqQztTQUNKO1FBQ0QsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQXFHRCxVQUFVO1FBQ04sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFDO0lBQy9ELENBQUM7O2tGQS9LUSxpQkFBaUI7eURBQWpCLGlCQUFpQixXQUFqQixpQkFBaUIsbUJBRmQsTUFBTTtrREFFVCxpQkFBaUI7Y0FIN0IsVUFBVTtlQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlLCBPbkRlc3Ryb3ksIFJlbmRlcmVyRmFjdG9yeTIsIFJlbmRlcmVyMn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7U3ViamVjdCwgT2JzZXJ2YWJsZX0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7S2V5c30gZnJvbSBcIkBzaW5lcXVhL2NvcmUvYmFzZVwiO1xuXG4vLyBCYXNlZCBvbiAgQm9vdHN0cmFwICh2NC40LjEpOiBkcm9wZG93bi5qc1xuXG5leHBvcnQgaW50ZXJmYWNlIERyb3Bkb3duRXZlbnQge1xuICAgIHR5cGU6IFwiY2xlYXJcIiB8IFwidG9nZ2xlXCI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRHJvcGRvd25DbGVhckV2ZW50IGV4dGVuZHMgRHJvcGRvd25FdmVudCB7XG4gICAgdHlwZTogXCJjbGVhclwiO1xuICAgIHNvdXJjZUV2ZW50OiBLZXlib2FyZEV2ZW50IHwgTW91c2VFdmVudCB8IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEcm9wZG93blRvZ2dsZUV2ZW50IGV4dGVuZHMgRHJvcGRvd25FdmVudCB7XG4gICAgdHlwZTogXCJ0b2dnbGVcIjtcbiAgICBlbGVtZW50OiBFbGVtZW50O1xufVxuXG5leHBvcnQgdHlwZSBEcm9wZG93bkV2ZW50cyA9IERyb3Bkb3duQ2xlYXJFdmVudCB8IERyb3Bkb3duVG9nZ2xlRXZlbnQ7XG5cbmV4cG9ydCBjb25zdCBnQ2xhc3NOYW1lID0ge1xuICAgIERJU0FCTEVEICAgICAgICA6ICdkaXNhYmxlZCcsXG4gICAgU0hPVyAgICAgICAgICAgIDogJ3Nob3cnLFxuICAgIERST1BVUCAgICAgICAgICA6ICdkcm9wdXAnLFxuICAgIERST1BSSUdIVCAgICAgICA6ICdkcm9wcmlnaHQnLFxuICAgIERST1BMRUZUICAgICAgICA6ICdkcm9wbGVmdCcsXG4gICAgTUVOVVJJR0hUICAgICAgIDogJ2Ryb3Bkb3duLW1lbnUtcmlnaHQnLFxuICAgIE1FTlVMRUZUICAgICAgICA6ICdkcm9wZG93bi1tZW51LWxlZnQnLFxuICAgIFBPU0lUSU9OX1NUQVRJQyA6ICdwb3NpdGlvbi1zdGF0aWMnXG59O1xuXG5leHBvcnQgY29uc3QgZ1NlbGVjdG9yID0ge1xuICAgIERST1BET1dOICAgICAgOiAnLmRyb3Bkb3duJyxcbiAgICBEQVRBX1RPR0dMRSAgIDogJ1tkYXRhLXRvZ2dsZT1cImRyb3Bkb3duXCJdJyxcbiAgICBGT1JNX0NISUxEICAgIDogJy5kcm9wZG93biBmb3JtJyxcbiAgICBNRU5VICAgICAgICAgIDogJy5kcm9wZG93bi1tZW51JyxcbiAgICBOQVZCQVJfTkFWICAgIDogJy5uYXZiYXItbmF2JyxcbiAgICBWSVNJQkxFX0lURU1TIDogJy5kcm9wZG93bi1tZW51IC5kcm9wZG93bi1pdGVtOm5vdCguZGlzYWJsZWQpOm5vdCg6ZGlzYWJsZWQpJ1xufTtcblxuZXhwb3J0IGNvbnN0IGdBdHRhY2htZW50TWFwID0ge1xuICAgIFRPUCAgICAgICA6ICd0b3Atc3RhcnQnLFxuICAgIFRPUEVORCAgICA6ICd0b3AtZW5kJyxcbiAgICBCT1RUT00gICAgOiAnYm90dG9tLXN0YXJ0JyxcbiAgICBCT1RUT01FTkQgOiAnYm90dG9tLWVuZCcsXG4gICAgUklHSFQgICAgIDogJ3JpZ2h0LXN0YXJ0JyxcbiAgICBSSUdIVEVORCAgOiAncmlnaHQtZW5kJyxcbiAgICBMRUZUICAgICAgOiAnbGVmdC1zdGFydCcsXG4gICAgTEVGVEVORCAgIDogJ2xlZnQtZW5kJ1xufTtcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46IFwicm9vdFwiXG59KVxuZXhwb3J0IGNsYXNzIEJzRHJvcGRvd25TZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICBwcm90ZWN0ZWQgX2V2ZW50czogU3ViamVjdDxEcm9wZG93bkV2ZW50cz47XG4gICAgcHJvdGVjdGVkIHVubGlzdGVuZXJzOiAoKCkgPT4gdm9pZClbXTtcbiAgICBwcm90ZWN0ZWQgcmVuZGVyZXI6IFJlbmRlcmVyMjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICByZW5kZXJlckZhY3Rvcnk6IFJlbmRlcmVyRmFjdG9yeTJcbiAgICApIHtcbiAgICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IFN1YmplY3Q8RHJvcGRvd25FdmVudHM+KCk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XG4gICAgICAgIHRoaXMudW5saXN0ZW5lcnMgPSBbXTtcbiAgICAgICAgdGhpcy51bmxpc3RlbmVycy5wdXNoKHRoaXMucmVuZGVyZXIubGlzdGVuKGRvY3VtZW50LCBcImtleWRvd25cIiwgdGhpcy5kYXRhQXBpS2V5ZG93bkhhbmRsZXIpKTtcbiAgICAgICAgdGhpcy51bmxpc3RlbmVycy5wdXNoKHRoaXMucmVuZGVyZXIubGlzdGVuKGRvY3VtZW50LCBcImNsaWNrXCIsIHRoaXMuY2xlYXJNZW51cykpO1xuICAgICAgICB0aGlzLnVubGlzdGVuZXJzLnB1c2godGhpcy5yZW5kZXJlci5saXN0ZW4oZG9jdW1lbnQsIFwia2V5dXBcIiwgdGhpcy5jbGVhck1lbnVzKSk7XG4gICAgICAgIHRoaXMudW5saXN0ZW5lcnMucHVzaCh0aGlzLnJlbmRlcmVyLmxpc3Rlbihkb2N1bWVudCwgXCJjbGlja1wiLCB0aGlzLnRvZ2dsZSkpO1xuICAgICAgICB0aGlzLnVubGlzdGVuZXJzLnB1c2godGhpcy5yZW5kZXJlci5saXN0ZW4oZG9jdW1lbnQsIFwiY2xpY2tcIiwgdGhpcy5mb3JtQ2hpbGRDbGljaykpO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLl9ldmVudHMuY29tcGxldGUoKTtcbiAgICAgICAgdGhpcy51bmxpc3RlbmVycy5mb3JFYWNoKCh1bmxpc3RlbmVyKSA9PiB1bmxpc3RlbmVyKCkpO1xuICAgIH1cblxuICAgIGdldCBldmVudHMoKTogT2JzZXJ2YWJsZTxEcm9wZG93bkV2ZW50cz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXZlbnRzO1xuICAgIH1cblxuICAgIHByaXZhdGUgbWF0Y2hEZXNjZW5kYW50KGJhc2U6IEVsZW1lbnQsIGV2ZW50OiBFdmVudCwgc2VsZWN0b3I6IHN0cmluZyk6IEhUTUxFbGVtZW50IHwgbnVsbCB7XG4gICAgICAgIGxldCBlbGVtZW50OiBIVE1MRWxlbWVudCB8IG51bGwgPSBldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgIHdoaWxlIChlbGVtZW50ICYmIGVsZW1lbnQgIT09IGJhc2UpIHtcbiAgICAgICAgICAgIGlmIChlbGVtZW50Lm1hdGNoZXMoc2VsZWN0b3IpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnRFbGVtZW50O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0U2VsZWN0b3JGcm9tRWxlbWVudChlbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgICAgICBsZXQgc2VsZWN0b3IgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10YXJnZXQnKTtcblxuICAgICAgICBpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAnIycpIHtcbiAgICAgICAgICAgIGNvbnN0IGhyZWZBdHRyID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2hyZWYnKTtcbiAgICAgICAgICAgIHNlbGVjdG9yID0gaHJlZkF0dHIgJiYgaHJlZkF0dHIgIT09ICcjJyA/IGhyZWZBdHRyLnRyaW0oKSA6ICcnO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKSA/IHNlbGVjdG9yIDogbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldFBhcmVudEZyb21FbGVtZW50KGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogTm9kZSB8IG51bGwge1xuICAgICAgICBsZXQgcGFyZW50OiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsO1xuICAgICAgICBjb25zdCBzZWxlY3RvciA9IHRoaXMuZ2V0U2VsZWN0b3JGcm9tRWxlbWVudChlbGVtZW50KTtcblxuICAgICAgICBpZiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgIHBhcmVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghcGFyZW50KSB7XG4gICAgICAgICAgICAvLyBBY2NvdW50IGZvciBzY3JvbGwgbWVudXMgYW5kIHN1YiBtZW51c1xuICAgICAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnRFbGVtZW50O1xuICAgICAgICAgICAgd2hpbGUgKHBhcmVudCAmJlxuICAgICAgICAgICAgICAgIChwYXJlbnQuY2xhc3NMaXN0LmNvbnRhaW5zKFwic3Etc2Nyb2xsLW1lbnVcIikgfHxcbiAgICAgICAgICAgICAgICBwYXJlbnQuY2xhc3NMaXN0LmNvbnRhaW5zKFwic3Etc2Nyb2xsLW1lbnUtaXRlbVwiKSB8fFxuICAgICAgICAgICAgICAgIHBhcmVudC5jbGFzc0xpc3QuY29udGFpbnMoXCJkcm9wZG93bi1zdWJtZW51XCIpKSkge1xuICAgICAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnRFbGVtZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwYXJlbnQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkYXRhQXBpS2V5ZG93bkhhbmRsZXIgPSAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpOiBib29sZWFuIHwgdm9pZCA9PiB7XG4gICAgICAgIGNvbnN0IGRlc2NlbmRhbnQgPSB0aGlzLm1hdGNoRGVzY2VuZGFudChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGV2ZW50LCBgJHtnU2VsZWN0b3IuREFUQV9UT0dHTEV9LCR7Z1NlbGVjdG9yLk1FTlV9YCk7XG4gICAgICAgIGlmICghZGVzY2VuZGFudCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8vIElmIG5vdCBpbnB1dC90ZXh0YXJlYTpcbiAgICAgICAgLy8gIC0gQW5kIG5vdCBhIGtleSBpbiBSRUdFWFBfS0VZRE9XTiA9PiBub3QgYSBkcm9wZG93biBjb21tYW5kXG4gICAgICAgIC8vIElmIGlucHV0L3RleHRhcmVhOlxuICAgICAgICAvLyAgLSBJZiBzcGFjZSBrZXkgPT4gbm90IGEgZHJvcGRvd24gY29tbWFuZFxuICAgICAgICAvLyAgLSBJZiBrZXkgaXMgb3RoZXIgdGhhbiBlc2NhcGVcbiAgICAgICAgLy8gICAgLSBJZiBrZXkgaXMgbm90IHVwIG9yIGRvd24gPT4gbm90IGEgZHJvcGRvd24gY29tbWFuZFxuICAgICAgICAvLyAgICAtIElmIHRyaWdnZXIgaW5zaWRlIHRoZSBtZW51ID0+IG5vdCBhIGRyb3Bkb3duIGNvbW1hbmRcbiAgICAgICAgaWYgKC9pbnB1dHx0ZXh0YXJlYS9pLnRlc3QoKGV2ZW50LnRhcmdldCBhcyBFbGVtZW50KS50YWdOYW1lKSA/XG4gICAgICAgICAgICBldmVudC53aGljaCA9PT0gS2V5cy5zcGFjZSB8fCBldmVudC53aGljaCAhPT0gS2V5cy5lc2MgJiZcbiAgICAgICAgICAgIChldmVudC53aGljaCAhPT0gS2V5cy5kb3duICYmIGV2ZW50LndoaWNoICE9PSBLZXlzLnVwIHx8IChldmVudC50YXJnZXQgYXMgRWxlbWVudCkuY2xvc2VzdChnU2VsZWN0b3IuTUVOVSkpIDpcbiAgICAgICAgICAgICEoZXZlbnQud2hpY2ggPT09IEtleXMudXAgfHwgZXZlbnQud2hpY2ggPT09IEtleXMuZG93biB8fCBldmVudC53aGljaCA9PT0gS2V5cy5lc2MpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcblxuICAgICAgICBpZiAoLypUT0RPIGRlc2NlbmRhbnQuZGlzYWJsZWQgfHwgKi9kZXNjZW5kYW50LmNsYXNzTGlzdC5jb250YWlucyhnQ2xhc3NOYW1lLkRJU0FCTEVEKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5nZXRQYXJlbnRGcm9tRWxlbWVudChkZXNjZW5kYW50KTtcbiAgICAgICAgY29uc3QgaXNBY3RpdmUgPSBwYXJlbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCAmJiBwYXJlbnQuY2xhc3NMaXN0LmNvbnRhaW5zKGdDbGFzc05hbWUuU0hPVyk7XG5cbiAgICAgICAgaWYgKCFpc0FjdGl2ZSAmJiBldmVudC53aGljaCA9PT0gS2V5cy5lc2MpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghaXNBY3RpdmUgfHwgaXNBY3RpdmUgJiYgKGV2ZW50LndoaWNoID09PSBLZXlzLmVzYyB8fCBldmVudC53aGljaCA9PT0gS2V5cy5zcGFjZSkpIHtcbiAgICAgICAgICAgIGlmIChldmVudC53aGljaCA9PT0gS2V5cy5lc2MpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0b2dnbGUgPSBwYXJlbnQgaW5zdGFuY2VvZiBFbGVtZW50ICYmIHBhcmVudC5xdWVyeVNlbGVjdG9yKGdTZWxlY3Rvci5EQVRBX1RPR0dMRSk7XG4gICAgICAgICAgICAgICAgaWYgKHRvZ2dsZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHRvZ2dsZS5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudChcImZvY3VzXCIsIHtidWJibGVzOiB0cnVlfSkpO1xuICAgICAgICAgICAgICAgICAgICAvLyBOQiAkKHRvZ2dsZSkudHJpZ2dlcignZm9jdXMnKSB3aWxsIHNldCB0aGUgZm9jdXMgb24gdG9nZ2xlXG4gICAgICAgICAgICAgICAgICAgIHRvZ2dsZS5mb2N1cygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZGVzY2VuZGFudC5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudChcImNsaWNrXCIsIHtidWJibGVzOiB0cnVlfSkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGl0ZW1zOiBIVE1MRWxlbWVudFtdID0gW107XG4gICAgICAgIGlmIChwYXJlbnQgaW5zdGFuY2VvZiBFbGVtZW50KSB7XG4gICAgICAgICAgICBpdGVtcyA9IGl0ZW1zLnNsaWNlLmNhbGwocGFyZW50LnF1ZXJ5U2VsZWN0b3JBbGwoZ1NlbGVjdG9yLlZJU0lCTEVfSVRFTVMpKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoKGl0ZW06IEVsZW1lbnQpID0+IGl0ZW0gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCAmJiAoaXRlbS5vZmZzZXRXaWR0aCA+IDAgfHwgaXRlbS5vZmZzZXRIZWlnaHQgPiAwKSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgaW5kZXggPSBpdGVtcy5pbmRleE9mKGV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudCk7XG5cbiAgICAgICAgaWYgKGV2ZW50LndoaWNoID09PSBLZXlzLnVwICYmIGluZGV4ID4gMCkgeyAvLyBVcFxuICAgICAgICAgICAgaW5kZXgtLTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChldmVudC53aGljaCA9PT0gS2V5cy5kb3duICYmIGluZGV4IDwgaXRlbXMubGVuZ3RoIC0gMSkgeyAvLyBEb3duXG4gICAgICAgICAgICBpbmRleCsrO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgICAgICAgaW5kZXggPSAwO1xuICAgICAgICB9XG5cbiAgICAgICAgaXRlbXNbaW5kZXhdLmZvY3VzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbGVhck1lbnVzID0gKGV2ZW50OiBLZXlib2FyZEV2ZW50IHwgTW91c2VFdmVudCk6IGJvb2xlYW4gfCB2b2lkID0+IHtcbiAgICAgICAgaWYgKGV2ZW50ICYmIChldmVudC53aGljaCA9PT0gMyAvKlJJR0hUX01PVVNFX0JVVFRPTl9XSElDSCovIHx8XG4gICAgICAgICAgICBldmVudC50eXBlID09PSAna2V5dXAnICYmIGV2ZW50LndoaWNoICE9PSBLZXlzLnRhYikpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9ldmVudHMubmV4dCh7dHlwZTogXCJjbGVhclwiLCBzb3VyY2VFdmVudDogZXZlbnR9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRvZ2dsZSA9IChldmVudDogVUlFdmVudCk6IGJvb2xlYW4gfCB2b2lkID0+IHtcbiAgICAgICAgY29uc3QgZGVzY2VuZGFudCA9IHRoaXMubWF0Y2hEZXNjZW5kYW50KGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZXZlbnQsIGdTZWxlY3Rvci5EQVRBX1RPR0dMRSk7XG4gICAgICAgIGlmICghZGVzY2VuZGFudCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLl9ldmVudHMubmV4dCh7dHlwZTogXCJ0b2dnbGVcIiwgZWxlbWVudDogZGVzY2VuZGFudH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybUNoaWxkQ2xpY2sgPSAoZXZlbnQ6IFVJRXZlbnQpOiBib29sZWFuIHwgdm9pZCA9PiB7XG4gICAgICAgIGlmICghdGhpcy5tYXRjaERlc2NlbmRhbnQoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBldmVudCwgZ1NlbGVjdG9yLkZPUk1fQ0hJTEQpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuXG4gICAgcmFpc2VDbGVhcigpIHtcbiAgICAgICAgdGhpcy5fZXZlbnRzLm5leHQoe3R5cGU6IFwiY2xlYXJcIiwgc291cmNlRXZlbnQ6IHVuZGVmaW5lZH0pO1xuICAgIH1cbn1cbiJdfQ==