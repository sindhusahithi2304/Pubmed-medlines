import { Injectable, Inject } from "@angular/core";
import { of } from "rxjs";
import { HttpService, START_CONFIG } from "@sinequa/core/web-services";
import { Utils } from "@sinequa/core/base";
import * as i0 from "@angular/core";
import * as i1 from "@sinequa/core/app-utils";
import * as i2 from "@sinequa/core/login";
import * as i3 from "@sinequa/core/web-services";
import * as i4 from "@sinequa/core/intl";
import * as i5 from "@sinequa/components/search";
export class MlAuditService extends HttpService {
    constructor(startConfig, appService, loginService, principalService, intlService, httpClient, searchService) {
        super(startConfig);
        this.appService = appService;
        this.loginService = loginService;
        this.principalService = principalService;
        this.intlService = intlService;
        this.httpClient = httpClient;
        this.searchService = searchService;
        this.requestInitializer = (request) => {
            request.body.$auditRecord = this.ensureAuditRecord(request.body.$auditRecord);
            return true;
        };
    }
    newTimestamp() {
        return (new Date()).toISOString();
    }
    calcDwellTime(event, defaultValue) {
        if (!event.timestamp) {
            return defaultValue;
        }
        return Date.now() - (new Date(event.timestamp)).getTime();
    }
    startSession() {
        this.endSession();
        if (this.principalService.principal) {
            this.session = {
                type: "session",
                subType: "start",
                id: Utils.guid(false),
                timestamp: this.newTimestamp(),
                userId: this.principalService.principal.userId,
                isAdmin: this.principalService.principal.isAdministrator,
                locale: this.intlService.currentLocale.name
            };
        }
    }
    endSession() {
        this.endQuery();
        if (this.session && this.session.sent) {
            this.notifyEvent({
                type: "session",
                subType: "end",
                id: this.session.id,
                dwellTime: this.calcDwellTime(this.session)
            });
        }
        this.session = undefined;
        this.query = undefined;
        this.results = undefined;
    }
    newQuery(event) {
        this.endQuery();
        if (event.query) {
            this.query = {
                type: "query",
                subType: "start",
                id: Utils.guid(false),
                sessionId: this.session ? this.session.id : undefined,
                indexes: this.appService.ccquery ? this.appService.ccquery.searchIndexes : undefined,
                timestamp: this.newTimestamp()
            };
        }
    }
    endQuery() {
        this.endResults();
        if (this.query && this.query.sent) {
            this.notifyEvent({
                type: "query",
                subType: "end",
                id: this.query.id,
                sessionId: this.session ? this.session.id : undefined,
                dwellTime: this.calcDwellTime(this.query)
            });
        }
        this.query = undefined;
        this.results = undefined;
    }
    newResults() {
        this.endResults();
        if (this.searchService.results && this.searchService.results.records) {
            this.results = {
                type: "results",
                subType: "start",
                id: Utils.guid(false),
                queryId: this.query ? this.query.id : undefined,
                sessionId: (!this.query && this.session) ? this.session.id : undefined,
                timestamp: this.newTimestamp(),
                queryText: this.searchService.query.text,
                queryHash: this.searchService.query.hash(),
                page: this.searchService.results.page,
                documentIds: this.searchService.results.records.map(record => record.id),
            };
        }
    }
    endResults() {
        if (this.results && this.results.sent) {
            this.notifyEvent({
                type: "results",
                subType: "end",
                id: this.results.id,
                queryId: this.query ? this.query.id : undefined,
                sessionId: (!this.query && this.session) ? this.session.id : undefined,
                dwellTime: this.calcDwellTime(this.results)
            });
        }
        this.results = undefined;
    }
    flushContext() {
        const events = [];
        if (this.session && !this.session.sent) {
            events.push(this.session);
        }
        if (this.query && !this.query.sent) {
            events.push(this.query);
        }
        if (this.results && !this.results.sent) {
            events.push(this.results);
        }
        if (events.length !== 0) {
            this.notifyEvent(events);
            events.forEach(event => event.sent = true);
        }
    }
    newAction(actionOrActionType, documentIds) {
        this.flushContext();
        const action = {
            type: "action",
            subType: undefined,
            actionType: "click",
            id: Utils.guid(false),
            resultsId: this.results ? this.results.id : undefined,
            queryId: (!this.results && this.query) ? this.query.id : undefined,
            sessionId: (!this.results && !this.query && this.session) ? this.session.id : undefined,
            documentIds: []
        };
        delete action.actionType;
        delete action.documentIds;
        if (Utils.isObject(actionOrActionType)) {
            Utils.merge(action, actionOrActionType);
        }
        else {
            action.actionType = actionOrActionType;
            if (documentIds) {
                action.documentIds = documentIds;
            }
        }
        return action;
    }
    endAction(action) {
        if (action) {
            this.notifyEvent({
                type: "action",
                subType: "end",
                id: action.id,
                resultsId: this.results ? this.results.id : undefined,
                queryId: (!this.results && this.query) ? this.query.id : undefined,
                sessionId: (!this.results && !this.query && this.session) ? this.session.id : undefined,
                dwellTime: this.calcDwellTime(action)
            });
        }
    }
    init() {
        Utils.subscribe(this.loginService.events, (event) => {
            switch (event.type) {
                case "session-start":
                    this.startSession();
                    break;
                case "session-end":
                    this.endSession();
                    break;
            }
        });
        Utils.subscribe(this.searchService.events, (event) => {
            switch (event.type) {
                case "new-query":
                    this.newQuery(event);
                    break;
                case "new-results":
                    this.newResults();
                    break;
            }
        });
    }
    notifyEvent(events) {
        if (!this.startConfig.mlAuditEnabled) {
            return of(undefined);
        }
        const observable = this.httpClient.post(this.makeUrl(MlAuditService.Endpoint), {
            events: events
        });
        Utils.subscribe(observable, (response) => {
            return response;
        }, (error) => {
            console.log("MlAuditService.notify failure - error: ", error);
        });
        return observable;
    }
    notify(actions, documentIds) {
        if (Utils.isString(actions)) {
            return this.notifyEvent(this.newAction(actions, documentIds));
        }
        else if (Utils.isArray(actions)) {
            return this.notifyEvent(actions.map(actionInit => this.newAction(actionInit)));
        }
        else {
            return this.notifyEvent(this.newAction(actions));
        }
    }
    ensureAuditRecord(auditEvents) {
        if (Utils.isObject(auditEvents)) {
            const auditRecord = auditEvents;
            if (auditRecord.auditEvents || auditRecord.mlAuditEvents) {
                if (auditRecord.mlAuditEvents) {
                    return {
                        auditEvents: auditRecord.auditEvents,
                        mlAuditEvents: auditRecord.mlAuditEvents.map(actionInit => this.newAction(actionInit))
                    };
                }
            }
        }
        return auditEvents; // leave unchanged
    }
}
MlAuditService.Endpoint = "ml.audit.notify";
MlAuditService.ɵfac = function MlAuditService_Factory(t) { return new (t || MlAuditService)(i0.ɵɵinject(START_CONFIG), i0.ɵɵinject(i1.AppService), i0.ɵɵinject(i2.LoginService), i0.ɵɵinject(i3.PrincipalWebService), i0.ɵɵinject(i4.IntlService), i0.ɵɵinject(i3.SqHttpClient), i0.ɵɵinject(i5.SearchService)); };
MlAuditService.ɵprov = i0.ɵɵdefineInjectable({ token: MlAuditService, factory: MlAuditService.ɵfac, providedIn: "root" });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(MlAuditService, [{
        type: Injectable,
        args: [{
                providedIn: "root"
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [START_CONFIG]
            }] }, { type: i1.AppService }, { type: i2.LoginService }, { type: i3.PrincipalWebService }, { type: i4.IntlService }, { type: i3.SqHttpClient }, { type: i5.SearchService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWwtYXVkaXQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLi9wcm9qZWN0cy9jb21wb25lbnRzL21hY2hpbmUtbGVhcm5pbmcvIiwic291cmNlcyI6WyJtbC1hdWRpdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRWpELE9BQU8sRUFBYSxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxFQUFvQyxXQUFXLEVBQUUsWUFBWSxFQUF3QyxNQUFNLDRCQUE0QixDQUFDO0FBSS9JLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQzs7Ozs7OztBQU16QyxNQUFNLE9BQU8sY0FBZSxTQUFRLFdBQVc7SUFNM0MsWUFDMEIsV0FBd0IsRUFDcEMsVUFBc0IsRUFDdEIsWUFBMEIsRUFDMUIsZ0JBQXFDLEVBQ3JDLFdBQXdCLEVBQ3hCLFVBQXdCLEVBQ3hCLGFBQTRCO1FBQ3RDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztRQU5ULGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFxQjtRQUNyQyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixlQUFVLEdBQVYsVUFBVSxDQUFjO1FBQ3hCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBc08xQyx1QkFBa0IsR0FBRyxDQUFDLE9BQXlCLEVBQVcsRUFBRTtZQUN4RCxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUM5RSxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDLENBQUE7SUF2T0QsQ0FBQztJQUVELFlBQVk7UUFDUixPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FB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QUFRLEdBQUcsaUJBQWlCLENBQUM7NEVBRDVDLGNBQWMsY0FPWCxZQUFZO3NEQVBmLGNBQWMsV0FBZCxjQUFjLG1CQUZYLE1BQU07a0RBRVQsY0FBYztjQUgxQixVQUFVO2VBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7O3NCQVFRLE1BQU07dUJBQUMsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZSwgSW5qZWN0fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHtIdHRwUmVxdWVzdH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XG5pbXBvcnQge09ic2VydmFibGUsIG9mfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHtQcmluY2lwYWxXZWJTZXJ2aWNlLCBTcUh0dHBDbGllbnQsIEh0dHBTZXJ2aWNlLCBTVEFSVF9DT05GSUcsIFN0YXJ0Q29uZmlnLCBBdWRpdEV2ZW50cywgQXVkaXRSZWNvcmR9IGZyb20gXCJAc2luZXF1YS9jb3JlL3dlYi1zZXJ2aWNlc1wiO1xuaW1wb3J0IHtMb2dpblNlcnZpY2V9IGZyb20gXCJAc2luZXF1YS9jb3JlL2xvZ2luXCI7XG5pbXBvcnQge0ludGxTZXJ2aWNlfSBmcm9tIFwiQHNpbmVxdWEvY29yZS9pbnRsXCI7XG5pbXBvcnQge0FwcFNlcnZpY2V9IGZyb20gXCJAc2luZXF1YS9jb3JlL2FwcC11dGlsc1wiO1xuaW1wb3J0IHtVdGlsc30gZnJvbSBcIkBzaW5lcXVhL2NvcmUvYmFzZVwiO1xuaW1wb3J0IHtTZWFyY2hTZXJ2aWNlfSBmcm9tIFwiQHNpbmVxdWEvY29tcG9uZW50cy9zZWFyY2hcIjtcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46IFwicm9vdFwiXG59KVxuZXhwb3J0IGNsYXNzIE1sQXVkaXRTZXJ2aWNlIGV4dGVuZHMgSHR0cFNlcnZpY2Uge1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEVuZHBvaW50ID0gXCJtbC5hdWRpdC5ub3RpZnlcIjtcbiAgICBzZXNzaW9uOiBNbEF1ZGl0U2VydmljZS5TZXNzaW9uIHwgdW5kZWZpbmVkO1xuICAgIHF1ZXJ5OiBNbEF1ZGl0U2VydmljZS5RdWVyeSB8IHVuZGVmaW5lZDtcbiAgICByZXN1bHRzOiBNbEF1ZGl0U2VydmljZS5SZXN1bHRzIHwgdW5kZWZpbmVkO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBJbmplY3QoU1RBUlRfQ09ORklHKSBzdGFydENvbmZpZzogU3RhcnRDb25maWcsXG4gICAgICAgIHByb3RlY3RlZCBhcHBTZXJ2aWNlOiBBcHBTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgbG9naW5TZXJ2aWNlOiBMb2dpblNlcnZpY2UsXG4gICAgICAgIHByb3RlY3RlZCBwcmluY2lwYWxTZXJ2aWNlOiBQcmluY2lwYWxXZWJTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgaW50bFNlcnZpY2U6IEludGxTZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgaHR0cENsaWVudDogU3FIdHRwQ2xpZW50LFxuICAgICAgICBwcm90ZWN0ZWQgc2VhcmNoU2VydmljZTogU2VhcmNoU2VydmljZSkge1xuICAgICAgICBzdXBlcihzdGFydENvbmZpZyk7XG4gICAgfVxuXG4gICAgbmV3VGltZXN0YW1wKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAobmV3IERhdGUoKSkudG9JU09TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBjYWxjRHdlbGxUaW1lKGV2ZW50OiBNbEF1ZGl0U2VydmljZS5FdmVudCwgZGVmYXVsdFZhbHVlPzogbnVtYmVyKTogbnVtYmVyIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgaWYgKCFldmVudC50aW1lc3RhbXApIHtcbiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIERhdGUubm93KCkgLSAobmV3IERhdGUoZXZlbnQudGltZXN0YW1wKSkuZ2V0VGltZSgpO1xuICAgIH1cblxuICAgIHN0YXJ0U2Vzc2lvbigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5lbmRTZXNzaW9uKCk7XG4gICAgICAgIGlmICh0aGlzLnByaW5jaXBhbFNlcnZpY2UucHJpbmNpcGFsKSB7XG4gICAgICAgICAgICB0aGlzLnNlc3Npb24gPSB7XG4gICAgICAgICAgICAgICAgdHlwZTogXCJzZXNzaW9uXCIsXG4gICAgICAgICAgICAgICAgc3ViVHlwZTogXCJzdGFydFwiLFxuICAgICAgICAgICAgICAgIGlkOiBVdGlscy5ndWlkKGZhbHNlKSxcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IHRoaXMubmV3VGltZXN0YW1wKCksXG4gICAgICAgICAgICAgICAgdXNlcklkOiB0aGlzLnByaW5jaXBhbFNlcnZpY2UucHJpbmNpcGFsLnVzZXJJZCxcbiAgICAgICAgICAgICAgICBpc0FkbWluOiB0aGlzLnByaW5jaXBhbFNlcnZpY2UucHJpbmNpcGFsLmlzQWRtaW5pc3RyYXRvcixcbiAgICAgICAgICAgICAgICBsb2NhbGU6IHRoaXMuaW50bFNlcnZpY2UuY3VycmVudExvY2FsZS5uYW1lXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZW5kU2Vzc2lvbigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5lbmRRdWVyeSgpO1xuICAgICAgICBpZiAodGhpcy5zZXNzaW9uICYmIHRoaXMuc2Vzc2lvbi5zZW50KSB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmeUV2ZW50KHtcbiAgICAgICAgICAgICAgICB0eXBlOiBcInNlc3Npb25cIixcbiAgICAgICAgICAgICAgICBzdWJUeXBlOiBcImVuZFwiLFxuICAgICAgICAgICAgICAgIGlkOiB0aGlzLnNlc3Npb24uaWQsXG4gICAgICAgICAgICAgICAgZHdlbGxUaW1lOiB0aGlzLmNhbGNEd2VsbFRpbWUodGhpcy5zZXNzaW9uKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXNzaW9uID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnF1ZXJ5ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnJlc3VsdHMgPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgbmV3UXVlcnkoZXZlbnQ6IFNlYXJjaFNlcnZpY2UuTmV3UXVlcnlFdmVudCk6IHZvaWQge1xuICAgICAgICB0aGlzLmVuZFF1ZXJ5KCk7XG4gICAgICAgIGlmIChldmVudC5xdWVyeSkge1xuICAgICAgICAgICAgdGhpcy5xdWVyeSA9IHtcbiAgICAgICAgICAgICAgICB0eXBlOiBcInF1ZXJ5XCIsXG4gICAgICAgICAgICAgICAgc3ViVHlwZTogXCJzdGFydFwiLFxuICAgICAgICAgICAgICAgIGlkOiBVdGlscy5ndWlkKGZhbHNlKSxcbiAgICAgICAgICAgICAgICBzZXNzaW9uSWQ6IHRoaXMuc2Vzc2lvbiA/IHRoaXMuc2Vzc2lvbi5pZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBpbmRleGVzOiB0aGlzLmFwcFNlcnZpY2UuY2NxdWVyeSA/IHRoaXMuYXBwU2VydmljZS5jY3F1ZXJ5LnNlYXJjaEluZGV4ZXMgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiB0aGlzLm5ld1RpbWVzdGFtcCgpXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZW5kUXVlcnkoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZW5kUmVzdWx0cygpO1xuICAgICAgICBpZiAodGhpcy5xdWVyeSAmJiB0aGlzLnF1ZXJ5LnNlbnQpIHtcbiAgICAgICAgICAgIHRoaXMubm90aWZ5RXZlbnQoe1xuICAgICAgICAgICAgICAgIHR5cGU6IFwicXVlcnlcIixcbiAgICAgICAgICAgICAgICBzdWJUeXBlOiBcImVuZFwiLFxuICAgICAgICAgICAgICAgIGlkOiB0aGlzLnF1ZXJ5LmlkLFxuICAgICAgICAgICAgICAgIHNlc3Npb25JZDogdGhpcy5zZXNzaW9uID8gdGhpcy5zZXNzaW9uLmlkIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIGR3ZWxsVGltZTogdGhpcy5jYWxjRHdlbGxUaW1lKHRoaXMucXVlcnkpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnF1ZXJ5ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnJlc3VsdHMgPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgbmV3UmVzdWx0cygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5lbmRSZXN1bHRzKCk7XG4gICAgICAgIGlmICh0aGlzLnNlYXJjaFNlcnZpY2UucmVzdWx0cyAmJiB0aGlzLnNlYXJjaFNlcnZpY2UucmVzdWx0cy5yZWNvcmRzKSB7XG4gICAgICAgICAgICB0aGlzLnJlc3VsdHMgPSB7XG4gICAgICAgICAgICAgICAgdHlwZTogXCJyZXN1bHRzXCIsXG4gICAgICAgICAgICAgICAgc3ViVHlwZTogXCJzdGFydFwiLFxuICAgICAgICAgICAgICAgIGlkOiBVdGlscy5ndWlkKGZhbHNlKSxcbiAgICAgICAgICAgICAgICBxdWVyeUlkOiB0aGlzLnF1ZXJ5ID8gdGhpcy5xdWVyeS5pZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBzZXNzaW9uSWQ6ICghdGhpcy5xdWVyeSAmJiB0aGlzLnNlc3Npb24pID8gdGhpcy5zZXNzaW9uLmlkIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogdGhpcy5uZXdUaW1lc3RhbXAoKSxcbiAgICAgICAgICAgICAgICBxdWVyeVRleHQ6IHRoaXMuc2VhcmNoU2VydmljZS5xdWVyeS50ZXh0LFxuICAgICAgICAgICAgICAgIHF1ZXJ5SGFzaDogdGhpcy5zZWFyY2hTZXJ2aWNlLnF1ZXJ5Lmhhc2goKSxcbiAgICAgICAgICAgICAgICBwYWdlOiB0aGlzLnNlYXJjaFNlcnZpY2UucmVzdWx0cy5wYWdlLFxuICAgICAgICAgICAgICAgIGRvY3VtZW50SWRzOiB0aGlzLnNlYXJjaFNlcnZpY2UucmVzdWx0cy5yZWNvcmRzLm1hcDxzdHJpbmc+KHJlY29yZCA9PiByZWNvcmQuaWQpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGVuZFJlc3VsdHMoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnJlc3VsdHMgJiYgdGhpcy5yZXN1bHRzLnNlbnQpIHtcbiAgICAgICAgICAgIHRoaXMubm90aWZ5RXZlbnQoe1xuICAgICAgICAgICAgICAgIHR5cGU6IFwicmVzdWx0c1wiLFxuICAgICAgICAgICAgICAgIHN1YlR5cGU6IFwiZW5kXCIsXG4gICAgICAgICAgICAgICAgaWQ6IHRoaXMucmVzdWx0cy5pZCxcbiAgICAgICAgICAgICAgICBxdWVyeUlkOiB0aGlzLnF1ZXJ5ID8gdGhpcy5xdWVyeS5pZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBzZXNzaW9uSWQ6ICghdGhpcy5xdWVyeSAmJiB0aGlzLnNlc3Npb24pID8gdGhpcy5zZXNzaW9uLmlkIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIGR3ZWxsVGltZTogdGhpcy5jYWxjRHdlbGxUaW1lKHRoaXMucmVzdWx0cylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVzdWx0cyA9IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZsdXNoQ29udGV4dCgpIHtcbiAgICAgICAgY29uc3QgZXZlbnRzOiBNbEF1ZGl0U2VydmljZS5FdmVudFtdID0gW107XG4gICAgICAgIGlmICh0aGlzLnNlc3Npb24gJiYgIXRoaXMuc2Vzc2lvbi5zZW50KSB7XG4gICAgICAgICAgICBldmVudHMucHVzaCh0aGlzLnNlc3Npb24pO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnF1ZXJ5ICYmICF0aGlzLnF1ZXJ5LnNlbnQpIHtcbiAgICAgICAgICAgIGV2ZW50cy5wdXNoKHRoaXMucXVlcnkpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnJlc3VsdHMgJiYgIXRoaXMucmVzdWx0cy5zZW50KSB7XG4gICAgICAgICAgICBldmVudHMucHVzaCh0aGlzLnJlc3VsdHMpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChldmVudHMubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmeUV2ZW50KGV2ZW50cyk7XG4gICAgICAgICAgICBldmVudHMuZm9yRWFjaChldmVudCA9PiBldmVudC5zZW50ID0gdHJ1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBuZXdBY3Rpb24oYWN0aW9uT3JBY3Rpb25UeXBlOiBNbEF1ZGl0U2VydmljZS5BY3Rpb25UeXBlIHwgTWxBdWRpdFNlcnZpY2UuQWN0aW9uSW5pdGlhbGl6ZXIsIGRvY3VtZW50SWRzPzogc3RyaW5nIHwgc3RyaW5nW10pOiBNbEF1ZGl0U2VydmljZS5BY3Rpb24ge1xuICAgICAgICB0aGlzLmZsdXNoQ29udGV4dCgpO1xuICAgICAgICBjb25zdCBhY3Rpb246IE1sQXVkaXRTZXJ2aWNlLkFjdGlvbiA9IHtcbiAgICAgICAgICAgIHR5cGU6IFwiYWN0aW9uXCIsXG4gICAgICAgICAgICBzdWJUeXBlOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBhY3Rpb25UeXBlOiBcImNsaWNrXCIsXG4gICAgICAgICAgICBpZDogVXRpbHMuZ3VpZChmYWxzZSksXG4gICAgICAgICAgICByZXN1bHRzSWQ6IHRoaXMucmVzdWx0cyA/IHRoaXMucmVzdWx0cy5pZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHF1ZXJ5SWQ6ICghdGhpcy5yZXN1bHRzICYmIHRoaXMucXVlcnkpID8gdGhpcy5xdWVyeS5pZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHNlc3Npb25JZDogKCF0aGlzLnJlc3VsdHMgJiYgIXRoaXMucXVlcnkgJiYgdGhpcy5zZXNzaW9uKSA/IHRoaXMuc2Vzc2lvbi5pZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGRvY3VtZW50SWRzOiBbXVxuICAgICAgICB9O1xuICAgICAgICBkZWxldGUgYWN0aW9uLmFjdGlvblR5cGU7XG4gICAgICAgIGRlbGV0ZSBhY3Rpb24uZG9jdW1lbnRJZHM7XG4gICAgICAgIGlmIChVdGlscy5pc09iamVjdChhY3Rpb25PckFjdGlvblR5cGUpKSB7XG4gICAgICAgICAgICBVdGlscy5tZXJnZShhY3Rpb24sIGFjdGlvbk9yQWN0aW9uVHlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBhY3Rpb24uYWN0aW9uVHlwZSA9IGFjdGlvbk9yQWN0aW9uVHlwZTtcbiAgICAgICAgICAgIGlmIChkb2N1bWVudElkcykge1xuICAgICAgICAgICAgICAgIGFjdGlvbi5kb2N1bWVudElkcyA9IGRvY3VtZW50SWRzO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY3Rpb247XG4gICAgfVxuXG4gICAgZW5kQWN0aW9uKGFjdGlvbjogTWxBdWRpdFNlcnZpY2UuQWN0aW9uKSB7XG4gICAgICAgIGlmIChhY3Rpb24pIHtcbiAgICAgICAgICAgIHRoaXMubm90aWZ5RXZlbnQoe1xuICAgICAgICAgICAgICAgIHR5cGU6IFwiYWN0aW9uXCIsXG4gICAgICAgICAgICAgICAgc3ViVHlwZTogXCJlbmRcIixcbiAgICAgICAgICAgICAgICBpZDogYWN0aW9uLmlkLFxuICAgICAgICAgICAgICAgIHJlc3VsdHNJZDogdGhpcy5yZXN1bHRzID8gdGhpcy5yZXN1bHRzLmlkIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIHF1ZXJ5SWQ6ICghdGhpcy5yZXN1bHRzICYmIHRoaXMucXVlcnkpID8gdGhpcy5xdWVyeS5pZCA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBzZXNzaW9uSWQ6ICghdGhpcy5yZXN1bHRzICYmICF0aGlzLnF1ZXJ5ICYmIHRoaXMuc2Vzc2lvbikgPyB0aGlzLnNlc3Npb24uaWQgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgZHdlbGxUaW1lOiB0aGlzLmNhbGNEd2VsbFRpbWUoYWN0aW9uKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpbml0KCkge1xuICAgICAgICBVdGlscy5zdWJzY3JpYmUodGhpcy5sb2dpblNlcnZpY2UuZXZlbnRzLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJzZXNzaW9uLXN0YXJ0XCI6XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRTZXNzaW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgXCJzZXNzaW9uLWVuZFwiOlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVuZFNlc3Npb24oKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBVdGlscy5zdWJzY3JpYmUodGhpcy5zZWFyY2hTZXJ2aWNlLmV2ZW50cywgKGV2ZW50KSA9PiB7XG4gICAgICAgICAgICBzd2l0Y2ggKGV2ZW50LnR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlIFwibmV3LXF1ZXJ5XCI6XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmV3UXVlcnkoZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFwibmV3LXJlc3VsdHNcIjpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5uZXdSZXN1bHRzKCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBub3RpZnlFdmVudChldmVudHM6IE1sQXVkaXRTZXJ2aWNlLkV2ZW50IHwgTWxBdWRpdFNlcnZpY2UuRXZlbnRbXSk6IE9ic2VydmFibGU8dm9pZD4ge1xuICAgICAgICBpZiAoIXRoaXMuc3RhcnRDb25maWcubWxBdWRpdEVuYWJsZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG9ic2VydmFibGUgPSB0aGlzLmh0dHBDbGllbnQucG9zdDx2b2lkPih0aGlzLm1ha2VVcmwoTWxBdWRpdFNlcnZpY2UuRW5kcG9pbnQpLCB7XG4gICAgICAgICAgICBldmVudHM6IGV2ZW50c1xuICAgICAgICB9KTtcbiAgICAgICAgVXRpbHMuc3Vic2NyaWJlKG9ic2VydmFibGUsXG4gICAgICAgICAgICAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJNbEF1ZGl0U2VydmljZS5ub3RpZnkgZmFpbHVyZSAtIGVycm9yOiBcIiwgZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBvYnNlcnZhYmxlO1xuICAgIH1cblxuICAgIG5vdGlmeShhY3Rpb25zOiBNbEF1ZGl0U2VydmljZS5BY3Rpb25Jbml0aWFsaXplciB8IE1sQXVkaXRTZXJ2aWNlLkFjdGlvbkluaXRpYWxpemVyW10gfCBNbEF1ZGl0U2VydmljZS5BY3Rpb25UeXBlLCBkb2N1bWVudElkcz86IHN0cmluZyB8IHN0cmluZ1tdKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICAgIGlmIChVdGlscy5pc1N0cmluZyhhY3Rpb25zKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubm90aWZ5RXZlbnQodGhpcy5uZXdBY3Rpb24oYWN0aW9ucywgZG9jdW1lbnRJZHMpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChVdGlscy5pc0FycmF5KGFjdGlvbnMpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ub3RpZnlFdmVudChhY3Rpb25zLm1hcChhY3Rpb25Jbml0ID0+IHRoaXMubmV3QWN0aW9uKGFjdGlvbkluaXQpKSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ub3RpZnlFdmVudCh0aGlzLm5ld0FjdGlvbihhY3Rpb25zKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGVuc3VyZUF1ZGl0UmVjb3JkKGF1ZGl0RXZlbnRzOiBBdWRpdEV2ZW50cyk6IEF1ZGl0UmVjb3JkIHtcbiAgICAgICAgaWYgKFV0aWxzLmlzT2JqZWN0KGF1ZGl0RXZlbnRzKSkge1xuICAgICAgICAgICAgY29uc3QgYXVkaXRSZWNvcmQgPSA8QXVkaXRSZWNvcmQ+YXVkaXRFdmVudHM7XG4gICAgICAgICAgICBpZiAoYXVkaXRSZWNvcmQuYXVkaXRFdmVudHMgfHwgYXVkaXRSZWNvcmQubWxBdWRpdEV2ZW50cykge1xuICAgICAgICAgICAgICAgIGlmIChhdWRpdFJlY29yZC5tbEF1ZGl0RXZlbnRzKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhdWRpdEV2ZW50czogYXVkaXRSZWNvcmQuYXVkaXRFdmVudHMsXG4gICAgICAgICAgICAgICAgICAgICAgICBtbEF1ZGl0RXZlbnRzOiBhdWRpdFJlY29yZC5tbEF1ZGl0RXZlbnRzLm1hcChhY3Rpb25Jbml0ID0+IHRoaXMubmV3QWN0aW9uKGFjdGlvbkluaXQpKVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gPEF1ZGl0UmVjb3JkPmF1ZGl0RXZlbnRzOyAvLyBsZWF2ZSB1bmNoYW5nZWRcbiAgICB9XG5cbiAgICByZXF1ZXN0SW5pdGlhbGl6ZXIgPSAocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IGJvb2xlYW4gPT4ge1xuICAgICAgICByZXF1ZXN0LmJvZHkuJGF1ZGl0UmVjb3JkID0gdGhpcy5lbnN1cmVBdWRpdFJlY29yZChyZXF1ZXN0LmJvZHkuJGF1ZGl0UmVjb3JkKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxufVxuXG5leHBvcnQgbW9kdWxlIE1sQXVkaXRTZXJ2aWNlIHtcbiAgICBleHBvcnQgdHlwZSBFdmVudFR5cGUgPSBcInNlc3Npb25cIiB8IFwicXVlcnlcIiB8IFwicmVzdWx0c1wiIHwgXCJhY3Rpb25cIjtcbiAgICBleHBvcnQgdHlwZSBFdmVudFN1YlR5cGUgPSBcInN0YXJ0XCIgfCBcImVuZFwiO1xuICAgIGV4cG9ydCB0eXBlIEFjdGlvblR5cGUgPSBcImNsaWNrXCIgfCBcInByZXZpZXdcIiB8IFwib3ZlclwiIHxcbiAgICAgICAgXCJhZGRUb0Jhc2tldFwiIHwgXCJyZW1vdmVGcm9tQmFza2V0XCIgfFxuICAgICAgICBcImFkZFRvTGFiZWxcIiB8IFwicmVtb3ZlRnJvbUxhYmVsXCIgfFxuICAgICAgICBcImFkZFJhdGluZ1wiIHwgXCJyZW1vdmVSYXRpbmdcIjtcblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgRXZlbnQge1xuICAgICAgICB0eXBlOiBFdmVudFR5cGU7XG4gICAgICAgIHN1YlR5cGU/OiBFdmVudFN1YlR5cGU7XG4gICAgICAgIGlkPzogc3RyaW5nO1xuICAgICAgICB0aW1lc3RhbXA/OiBzdHJpbmc7XG4gICAgICAgIGR3ZWxsVGltZT86IG51bWJlcjtcbiAgICAgICAgc2VudD86IGJvb2xlYW47XG4gICAgICAgIFtrZXk6IHN0cmluZ106IGFueTsgLy8gQWxsb3cgYXJiaXRyYXJ5IGFkZGl0aW9uc1xuICAgIH1cblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgU2Vzc2lvbiBleHRlbmRzIEV2ZW50IHtcbiAgICAgICAgdXNlcklkOiBzdHJpbmc7XG4gICAgICAgIGxvY2FsZTogc3RyaW5nO1xuICAgIH1cblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgUXVlcnkgZXh0ZW5kcyBFdmVudCB7XG4gICAgICAgIHNlc3Npb25JZD86IHN0cmluZztcbiAgICAgICAgaW5kZXhlcz86IHN0cmluZztcbiAgICAgICAgdHlwaW5nSGlzdG9yeT86IGFueTtcbiAgICAgICAgcHJvcG9zZWRFeHBhbnNpb25zPzogYW55O1xuICAgICAgICBzZWxlY3RlZEV4cGFuc2lvbnM/OiBhbnk7XG4gICAgfVxuXG4gICAgZXhwb3J0IGludGVyZmFjZSBSZXN1bHRzIGV4dGVuZHMgRXZlbnQge1xuICAgICAgICBxdWVyeUlkPzogc3RyaW5nO1xuICAgICAgICBzZXNzaW9uSWQ/OiBzdHJpbmc7XG4gICAgICAgIHF1ZXJ5VGV4dD86IHN0cmluZztcbiAgICAgICAgcXVlcnlIYXNoPzogc3RyaW5nO1xuICAgICAgICBkb2N1bWVudElkcz86IHN0cmluZ1tdO1xuICAgICAgICBwYWdlPzogbnVtYmVyO1xuICAgIH1cblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgQWN0aW9uIGV4dGVuZHMgRXZlbnQge1xuICAgICAgICByZXN1bHRzSWQ/OiBzdHJpbmc7XG4gICAgICAgIHF1ZXJ5SWQ/OiBzdHJpbmc7XG4gICAgICAgIHNlc3Npb25JZD86IHN0cmluZztcbiAgICAgICAgYWN0aW9uVHlwZT86IEFjdGlvblR5cGU7XG4gICAgICAgIGRvY3VtZW50SWRzPzogc3RyaW5nIHwgc3RyaW5nW107XG4gICAgfVxuXG4gICAgZXhwb3J0IGludGVyZmFjZSBBY3Rpb25Jbml0aWFsaXplciB7XG4gICAgICAgIGFjdGlvblR5cGU6IEFjdGlvblR5cGU7XG4gICAgICAgIGRvY3VtZW50SWRzOiBzdHJpbmcgfCBzdHJpbmdbXTtcbiAgICAgICAgW2tleTogc3RyaW5nXTogYW55OyAvLyBBbGxvdyBhcmJpdHJhcnkgYWRkaXRpb25zXG4gICAgfVxufVxuIl19