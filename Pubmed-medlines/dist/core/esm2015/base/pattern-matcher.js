import { Utils } from "./utils";
/**
 * Defines the different pattern types
 * `Empty`: no pattern
 * `RegExp`: a regular expression pattern
 * `Value`: a literal value
 */
export var PatternType;
(function (PatternType) {
    PatternType[PatternType["Empty"] = 0] = "Empty";
    PatternType[PatternType["RegExp"] = 1] = "RegExp";
    // WildCard = 2,
    PatternType[PatternType["Value"] = 3] = "Value";
})(PatternType || (PatternType = {}));
/**
 * A class that represents a single pattern. The pattern type is deduced automatically from the input pattern text.
 *
 * `<empty string>` => `Empty`
 * `<pattern with wildcards ?*>` => `RegExp` (wildcards are converted to regular expressions)
 * `<pattern starting with ~>` => `RegExp` (the text following the ~ character is treated as a regular expression)
 * `<any other value>` => `Value` (a literal value that is matched as-is)
 */
export class Pattern {
    constructor(pattern) {
        if (!pattern) {
            this.clear();
        }
        else {
            this.load(pattern);
        }
    }
    get type() {
        return this._type;
    }
    get text() {
        return this._text;
    }
    static getPatternType(pattern) {
        if (!pattern) {
            return PatternType.Empty;
        }
        if (pattern[0] === "~" || pattern.includes("*") || pattern.includes("?")) {
            return PatternType.RegExp;
        }
        return PatternType.Value;
    }
    static isPattern(pattern) {
        if (!pattern) {
            return false;
        }
        if (pattern[0] === "~" || pattern.includes("*") || pattern.includes("?")) {
            return true;
        }
        return false;
    }
    static doMatch(pattern, text) {
        const _pattern = new Pattern();
        _pattern.load(pattern);
        return _pattern.isMatch(text);
    }
    static wildcardToRegex(pattern) {
        if (!pattern) {
            return pattern;
        }
        return "^" + Utils.regExEscape(pattern).replace("\\*", ".*").replace("\\?", ".") + "$";
    }
    static cleanPattern(s) {
        if (!s) {
            return s;
        }
        const sb = [];
        let lastIsStar = false;
        for (const ch of s) {
            if (ch === "*") {
                if (!lastIsStar) {
                    lastIsStar = true;
                    sb.push(ch);
                }
            }
            else {
                lastIsStar = false;
                sb.push(ch);
            }
        }
        return sb.join("");
    }
    clear() {
        this.reg = undefined;
        this._text = undefined;
        this.preparedPattern1 = undefined;
        // this.preparedPattern2 = undefined;
        this._type = PatternType.Empty;
    }
    isEmpty() {
        return this._type === PatternType.Empty;
    }
    load(pattern) {
        this.clear();
        try {
            let s = pattern;
            this._text = pattern;
            this._type = Pattern.getPatternType(s);
            if (this._type === PatternType.Empty) {
                return true;
            }
            if (this._type === PatternType.Value) {
                this.preparedPattern1 = s;
                return true;
            }
            if (this._type === PatternType.RegExp) {
                if (s[0] === "~") {
                    s = s.substring(1);
                }
                else {
                    s = Pattern.wildcardToRegex(Pattern.cleanPattern(s));
                }
                this.preparedPattern1 = s;
                this.reg = new RegExp(s, "i");
                return true;
            }
            return false;
        }
        catch (e) {
            console.log(`Pattern.Load '${pattern}' error:`, e);
            this.clear();
            return false;
        }
    }
    getTypeValueText() {
        if (this.type === PatternType.Value) {
            return this.preparedPattern1;
        }
        return undefined;
    }
    getTypeRegexPattern() {
        if (this.type === PatternType.RegExp) {
            return this.preparedPattern1;
        }
        return undefined;
    }
    isTypeValue() {
        return this.type === PatternType.Value;
    }
    isMatch(text) {
        var _a;
        text = text || "";
        switch (this._type) {
            default:
            case PatternType.Empty:
                return true;
            case PatternType.Value:
                return Utils.eqNC(text, this.preparedPattern1 || "");
            case PatternType.RegExp:
                return ((_a = this.reg) === null || _a === void 0 ? void 0 : _a.test(text)) || false;
        }
    }
}
export class Patterns {
    constructor(text) {
        this.text = text;
    }
    clear() {
        this._preparedPatterns = undefined;
        this._values = undefined;
        this._isEmpty = true;
    }
    get text() {
        return this._text;
    }
    set text(value) {
        if (value === this._text) {
            return;
        }
        this._text = value;
        const l = Utils.split(this._text || "", ";");
        this.innerSetList(l);
    }
    getTypeCount(type) {
        if (!this._preparedPatterns) {
            return 0;
        }
        if (type === PatternType.Value) {
            return !!this._values ? Object.keys(this._values).length : 0;
        }
        let count = 0;
        for (const pattern of this._preparedPatterns) {
            if (pattern.type === type) {
                count++;
            }
        }
        return count;
    }
    innerSetList(l) {
        this._preparedPatterns = undefined;
        this._values = undefined;
        this._isEmpty = true;
        if (!!l) {
            for (const s of l) {
                if (!s) {
                    continue;
                }
                const pattern = new Pattern();
                if (pattern.load(s)) {
                    if (!this._preparedPatterns) {
                        this._preparedPatterns = [];
                    }
                    this._preparedPatterns.push(pattern);
                }
            }
        }
        if (this._preparedPatterns) {
            const c = this._preparedPatterns.length;
            if (c > 0) {
                this._isEmpty = false;
            }
            for (let i = c - 1; i >= 0; i--) {
                const pattern = this._preparedPatterns[i];
                //do values
                if (pattern.isTypeValue()) {
                    if (!this._values) {
                        this._values = {};
                    }
                    const val = pattern.getTypeValueText() || "";
                    this._values[val] = true;
                    this._preparedPatterns.splice(i, 1);
                }
            }
        }
    }
    get list() {
        return Utils.split(this.text || "", ";");
    }
    set list(value) {
        this.text = !!value ? value.join(";") : undefined;
        this.innerSetList(value);
    }
    setText(list) {
        this.list = list;
    }
    isEmpty() {
        return this._isEmpty;
    }
    hasPatterns() {
        return !this.isEmpty();
    }
    isMatch(name, logdisplay) {
        if (this.isEmpty()) {
            return true;
        }
        if (!!this._values) {
            if (this._values[name]) {
                if (!!logdisplay) {
                    console.log(logdisplay, ` : the pattern '${name}' matches the value '${name}'`);
                }
                return true;
            }
        }
        if (!!this._preparedPatterns) {
            for (const pattern of this._preparedPatterns) {
                if (!pattern) {
                    continue;
                }
                if (pattern.isTypeValue()) {
                    continue;
                }
                if (pattern.isMatch(name)) {
                    if (!!logdisplay) {
                        console.log(logdisplay, ` : the pattern '${pattern.text}' matches the value '${name}'`);
                    }
                    return true;
                }
            }
        }
        return false;
    }
}
/**
 * This class is used to process "included" and "excluded" patterns typically specified in the Sinequa configuration.
 */
export class PatternMatcher {
    constructor(includedLogDisplay, excludedLogDisplay) {
        this.includedPattern = new Patterns();
        this.excludedPattern = new Patterns();
        this.includedLogDisplay = includedLogDisplay;
        this.excludedLogDisplay = excludedLogDisplay;
    }
    get included() {
        return this.includedPattern.text;
    }
    set included(value) {
        this.includedPattern.text = value;
    }
    get excluded() {
        return this.excludedPattern.text;
    }
    set excluded(value) {
        this.excludedPattern.text = value;
    }
    set includedList(value) {
        this.includedPattern.list = value;
    }
    set excludedList(value) {
        this.excludedPattern.list = value;
    }
    hasPatterns() {
        return this.includedPattern.hasPatterns() || this.excludedPattern.hasPatterns();
    }
    isExcluded(name) {
        return !this.isIncluded(name);
    }
    isIncluded(name) {
        if (!name) {
            return true;
        }
        if (this.includedPattern.hasPatterns()) {
            if (this.excludedPattern.hasPatterns()) {
                if (this.excludedPattern.isMatch(name, this.excludedLogDisplay)) {
                    return false;
                }
            }
            if (!this.includedPattern.isMatch(name, this.includedLogDisplay)) {
                return false;
            }
            return true;
        }
        else if (this.excludedPattern.hasPatterns()) {
            if (this.excludedPattern.isMatch(name, this.excludedLogDisplay)) {
                return false;
            }
            return true;
        }
        return true;
    }
    isExplicitlyIncluded(name) {
        return this.includedPattern.hasPatterns() && this.includedPattern.isMatch(name, this.includedLogDisplay);
    }
    isExplicitlyExcluded(name) {
        return this.excludedPattern.hasPatterns() && this.excludedPattern.isMatch(name, this.excludedLogDisplay);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0dGVybi1tYXRjaGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUvYmFzZS8iLCJzb3VyY2VzIjpbInBhdHRlcm4tbWF0Y2hlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBRTlCOzs7OztHQUtHO0FBQ0gsTUFBTSxDQUFOLElBQVksV0FLWDtBQUxELFdBQVksV0FBVztJQUNuQiwrQ0FBUyxDQUFBO0lBQ1QsaURBQVUsQ0FBQTtJQUNWLGdCQUFnQjtJQUNoQiwrQ0FBUyxDQUFBO0FBQ2IsQ0FBQyxFQUxXLFdBQVcsS0FBWCxXQUFXLFFBS3RCO0FBRUQ7Ozs7Ozs7R0FPRztBQUNILE1BQU0sT0FBTyxPQUFPO0lBOENoQixZQUFtQixPQUFnQjtRQUMvQixJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1YsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ2hCO2FBQ0k7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3RCO0lBQ0wsQ0FBQztJQW5ERCxJQUFXLElBQUk7UUFDWCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDdEIsQ0FBQztJQUtELElBQVcsSUFBSTtRQUNYLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUN0QixDQUFDO0lBRU0sTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFlO1FBQ3hDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDVixPQUFPLFdBQVcsQ0FBQyxLQUFLLENBQUM7U0FDNUI7UUFDRCxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3RFLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQztTQUM3QjtRQUNELE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FB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QUMsQ0FBQztJQUM3RyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1V0aWxzfSBmcm9tIFwiLi91dGlsc1wiO1xuXG4vKipcbiAqIERlZmluZXMgdGhlIGRpZmZlcmVudCBwYXR0ZXJuIHR5cGVzXG4gKiBgRW1wdHlgOiBubyBwYXR0ZXJuXG4gKiBgUmVnRXhwYDogYSByZWd1bGFyIGV4cHJlc3Npb24gcGF0dGVyblxuICogYFZhbHVlYDogYSBsaXRlcmFsIHZhbHVlXG4gKi9cbmV4cG9ydCBlbnVtIFBhdHRlcm5UeXBlIHtcbiAgICBFbXB0eSA9IDAsXG4gICAgUmVnRXhwID0gMSxcbiAgICAvLyBXaWxkQ2FyZCA9IDIsXG4gICAgVmFsdWUgPSAzXG59XG5cbi8qKlxuICogQSBjbGFzcyB0aGF0IHJlcHJlc2VudHMgYSBzaW5nbGUgcGF0dGVybi4gVGhlIHBhdHRlcm4gdHlwZSBpcyBkZWR1Y2VkIGF1dG9tYXRpY2FsbHkgZnJvbSB0aGUgaW5wdXQgcGF0dGVybiB0ZXh0LlxuICpcbiAqIGA8ZW1wdHkgc3RyaW5nPmAgPT4gYEVtcHR5YFxuICogYDxwYXR0ZXJuIHdpdGggd2lsZGNhcmRzID8qPmAgPT4gYFJlZ0V4cGAgKHdpbGRjYXJkcyBhcmUgY29udmVydGVkIHRvIHJlZ3VsYXIgZXhwcmVzc2lvbnMpXG4gKiBgPHBhdHRlcm4gc3RhcnRpbmcgd2l0aCB+PmAgPT4gYFJlZ0V4cGAgKHRoZSB0ZXh0IGZvbGxvd2luZyB0aGUgfiBjaGFyYWN0ZXIgaXMgdHJlYXRlZCBhcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbilcbiAqIGA8YW55IG90aGVyIHZhbHVlPmAgPT4gYFZhbHVlYCAoYSBsaXRlcmFsIHZhbHVlIHRoYXQgaXMgbWF0Y2hlZCBhcy1pcylcbiAqL1xuZXhwb3J0IGNsYXNzIFBhdHRlcm4ge1xuICAgIHByaXZhdGUgX3R5cGU6IFBhdHRlcm5UeXBlO1xuICAgIHB1YmxpYyBnZXQgdHlwZSgpOiBQYXR0ZXJuVHlwZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl90eXBlO1xuICAgIH1cbiAgICBwcml2YXRlIHJlZz86IFJlZ0V4cDtcbiAgICBwcml2YXRlIHByZXBhcmVkUGF0dGVybjE/OiBzdHJpbmc7XG4gICAgLy8gcHJpdmF0ZSBwcmVwYXJlZFBhdHRlcm4yOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBfdGV4dD86IHN0cmluZztcbiAgICBwdWJsaWMgZ2V0IHRleHQoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RleHQ7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBnZXRQYXR0ZXJuVHlwZShwYXR0ZXJuOiBzdHJpbmcpOiBQYXR0ZXJuVHlwZSB7XG4gICAgICAgIGlmICghcGF0dGVybikge1xuICAgICAgICAgICAgcmV0dXJuIFBhdHRlcm5UeXBlLkVtcHR5O1xuICAgICAgICB9XG4gICAgICAgIGlmIChwYXR0ZXJuWzBdID09PSBcIn5cIiB8fCBwYXR0ZXJuLmluY2x1ZGVzKFwiKlwiKSB8fCBwYXR0ZXJuLmluY2x1ZGVzKFwiP1wiKSkge1xuICAgICAgICAgICAgcmV0dXJuIFBhdHRlcm5UeXBlLlJlZ0V4cDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUGF0dGVyblR5cGUuVmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBpc1BhdHRlcm4ocGF0dGVybjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghcGF0dGVybikge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwYXR0ZXJuWzBdID09PSBcIn5cIiB8fCBwYXR0ZXJuLmluY2x1ZGVzKFwiKlwiKSB8fCBwYXR0ZXJuLmluY2x1ZGVzKFwiP1wiKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZG9NYXRjaChwYXR0ZXJuOiBzdHJpbmcsIHRleHQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBfcGF0dGVybiA9IG5ldyBQYXR0ZXJuKCk7XG4gICAgICAgIF9wYXR0ZXJuLmxvYWQocGF0dGVybik7XG4gICAgICAgIHJldHVybiBfcGF0dGVybi5pc01hdGNoKHRleHQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgd2lsZGNhcmRUb1JlZ2V4KHBhdHRlcm46IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGlmICghcGF0dGVybikge1xuICAgICAgICAgICAgcmV0dXJuIHBhdHRlcm47XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFwiXlwiICsgVXRpbHMucmVnRXhFc2NhcGUocGF0dGVybikucmVwbGFjZShcIlxcXFwqXCIsIFwiLipcIikucmVwbGFjZShcIlxcXFw/XCIsIFwiLlwiKSArIFwiJFwiO1xuICAgIH1cblxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvcihwYXR0ZXJuPzogc3RyaW5nKSB7XG4gICAgICAgIGlmICghcGF0dGVybikge1xuICAgICAgICAgICAgdGhpcy5jbGVhcigpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2FkKHBhdHRlcm4pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgY2xlYW5QYXR0ZXJuKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGlmICghcykge1xuICAgICAgICAgICAgcmV0dXJuIHM7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2I6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGxldCBsYXN0SXNTdGFyID0gZmFsc2U7XG4gICAgICAgIGZvciAoY29uc3QgY2ggb2Ygcykge1xuICAgICAgICAgICAgaWYgKGNoID09PSBcIipcIikge1xuICAgICAgICAgICAgICAgIGlmICghbGFzdElzU3Rhcikge1xuICAgICAgICAgICAgICAgICAgICBsYXN0SXNTdGFyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgc2IucHVzaChjaCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgbGFzdElzU3RhciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHNiLnB1c2goY2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzYi5qb2luKFwiXCIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjbGVhcigpOnZvaWQge1xuICAgICAgICB0aGlzLnJlZz0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLl90ZXh0ID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLnByZXBhcmVkUGF0dGVybjEgPSB1bmRlZmluZWQ7XG4gICAgICAgIC8vIHRoaXMucHJlcGFyZWRQYXR0ZXJuMiA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5fdHlwZSA9IFBhdHRlcm5UeXBlLkVtcHR5O1xuICAgIH1cblxuICAgIHB1YmxpYyBpc0VtcHR5KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fdHlwZSA9PT0gUGF0dGVyblR5cGUuRW1wdHk7XG4gICAgfVxuXG4gICAgcHVibGljIGxvYWQocGF0dGVybjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCBzID0gcGF0dGVybjtcbiAgICAgICAgICAgIHRoaXMuX3RleHQgPSBwYXR0ZXJuO1xuICAgICAgICAgICAgdGhpcy5fdHlwZSA9IFBhdHRlcm4uZ2V0UGF0dGVyblR5cGUocyk7XG4gICAgICAgICAgICBpZiAodGhpcy5fdHlwZSA9PT0gUGF0dGVyblR5cGUuRW1wdHkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLl90eXBlID09PSBQYXR0ZXJuVHlwZS5WYWx1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMucHJlcGFyZWRQYXR0ZXJuMT0gcyA7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5fdHlwZSA9PT0gUGF0dGVyblR5cGUuUmVnRXhwKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNbMF0gPT09IFwiflwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHMgPSBzLnN1YnN0cmluZygxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHMgPSBQYXR0ZXJuLndpbGRjYXJkVG9SZWdleChQYXR0ZXJuLmNsZWFuUGF0dGVybihzKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMucHJlcGFyZWRQYXR0ZXJuMSA9IHM7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWcgPSBuZXcgUmVnRXhwKHMsIFwiaVwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYFBhdHRlcm4uTG9hZCAnJHtwYXR0ZXJufScgZXJyb3I6YCwgZSk7XG4gICAgICAgICAgICB0aGlzLmNsZWFyKCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0VHlwZVZhbHVlVGV4dCgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgICAgICBpZiAodGhpcy50eXBlID09PSBQYXR0ZXJuVHlwZS5WYWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJlcGFyZWRQYXR0ZXJuMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRUeXBlUmVnZXhQYXR0ZXJuKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIGlmICh0aGlzLnR5cGUgPT09IFBhdHRlcm5UeXBlLlJlZ0V4cCkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJlcGFyZWRQYXR0ZXJuMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc1R5cGVWYWx1ZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gUGF0dGVyblR5cGUuVmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIGlzTWF0Y2godGV4dDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHRleHQgPSB0ZXh0IHx8IFwiXCI7XG4gICAgICAgIHN3aXRjaCAodGhpcy5fdHlwZSkge1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIGNhc2UgUGF0dGVyblR5cGUuRW1wdHk6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICBjYXNlIFBhdHRlcm5UeXBlLlZhbHVlOlxuICAgICAgICAgICAgICAgIHJldHVybiBVdGlscy5lcU5DKHRleHQsIHRoaXMucHJlcGFyZWRQYXR0ZXJuMSB8fCBcIlwiKTtcbiAgICAgICAgICAgIGNhc2UgUGF0dGVyblR5cGUuUmVnRXhwOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlZz8udGVzdCh0ZXh0KSB8fCBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFBhdHRlcm5zIHtcbiAgICBwcml2YXRlIF90ZXh0Pzogc3RyaW5nO1xuICAgIHByaXZhdGUgX3ByZXBhcmVkUGF0dGVybnM/OiBQYXR0ZXJuW107XG4gICAgcHJpdmF0ZSBfdmFsdWVzPzogeyBba2V5OiBzdHJpbmddOiB0cnVlIH07XG4gICAgcHJpdmF0ZSBfaXNFbXB0eTogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKHRleHQ/OiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy50ZXh0ID0gdGV4dDtcbiAgICB9XG5cbiAgICBwdWJsaWMgY2xlYXIoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3ByZXBhcmVkUGF0dGVybnMgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuX3ZhbHVlcyA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5faXNFbXB0eSA9IHRydWU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCB0ZXh0KCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLl90ZXh0O1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgdGV4dCh2YWx1ZTogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gdGhpcy5fdGV4dCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3RleHQgPSB2YWx1ZTtcbiAgICAgICAgY29uc3QgbCA9IFV0aWxzLnNwbGl0KHRoaXMuX3RleHQgfHwgXCJcIiwgXCI7XCIpO1xuICAgICAgICB0aGlzLmlubmVyU2V0TGlzdChsKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBnZXRUeXBlQ291bnQodHlwZTogUGF0dGVyblR5cGUpOiBudW1iZXIge1xuICAgICAgICBpZiAoIXRoaXMuX3ByZXBhcmVkUGF0dGVybnMpIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlID09PSBQYXR0ZXJuVHlwZS5WYWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuICEhdGhpcy5fdmFsdWVzID8gT2JqZWN0LmtleXModGhpcy5fdmFsdWVzKS5sZW5ndGggOiAwO1xuICAgICAgICB9XG4gICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiB0aGlzLl9wcmVwYXJlZFBhdHRlcm5zKSB7XG4gICAgICAgICAgICBpZiAocGF0dGVybi50eXBlID09PSB0eXBlKSB7XG4gICAgICAgICAgICAgICAgY291bnQrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY291bnQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbm5lclNldExpc3QobDogc3RyaW5nW10gfCB1bmRlZmluZWQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fcHJlcGFyZWRQYXR0ZXJucyA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5fdmFsdWVzID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLl9pc0VtcHR5ID0gdHJ1ZTtcblxuICAgICAgICBpZiAoISFsKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHMgb2YgbCkge1xuICAgICAgICAgICAgICAgIGlmICghcykge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgcGF0dGVybiA9IG5ldyBQYXR0ZXJuKCk7XG4gICAgICAgICAgICAgICAgaWYgKHBhdHRlcm4ubG9hZChzKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3ByZXBhcmVkUGF0dGVybnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ByZXBhcmVkUGF0dGVybnMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wcmVwYXJlZFBhdHRlcm5zLnB1c2gocGF0dGVybik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLl9wcmVwYXJlZFBhdHRlcm5zKSB7XG4gICAgICAgICAgICBjb25zdCBjID0gdGhpcy5fcHJlcGFyZWRQYXR0ZXJucy5sZW5ndGg7XG4gICAgICAgICAgICBpZiAoYyA+IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9pc0VtcHR5ID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gYyAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGF0dGVybiA9IHRoaXMuX3ByZXBhcmVkUGF0dGVybnNbaV07XG4gICAgICAgICAgICAgICAgLy9kbyB2YWx1ZXNcbiAgICAgICAgICAgICAgICBpZiAocGF0dGVybi5pc1R5cGVWYWx1ZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fdmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl92YWx1ZXMgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBwYXR0ZXJuLmdldFR5cGVWYWx1ZVRleHQoKSB8fCBcIlwiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl92YWx1ZXNbdmFsXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3ByZXBhcmVkUGF0dGVybnMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgbGlzdCgpOiBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiBVdGlscy5zcGxpdCh0aGlzLnRleHQgfHwgXCJcIiwgXCI7XCIpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgbGlzdCh2YWx1ZTogc3RyaW5nW10pIHtcbiAgICAgICAgdGhpcy50ZXh0ID0gISF2YWx1ZSA/IHZhbHVlLmpvaW4oXCI7XCIpIDogdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmlubmVyU2V0TGlzdCh2YWx1ZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldFRleHQobGlzdDogc3RyaW5nW10pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5saXN0ID0gbGlzdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNFbXB0eSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzRW1wdHk7XG4gICAgfVxuXG4gICAgcHVibGljIGhhc1BhdHRlcm5zKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gIXRoaXMuaXNFbXB0eSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc01hdGNoKG5hbWU6IHN0cmluZywgbG9nZGlzcGxheT86IHN0cmluZykge1xuICAgICAgICBpZiAodGhpcy5pc0VtcHR5KCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEhdGhpcy5fdmFsdWVzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fdmFsdWVzW25hbWVdKSB7XG4gICAgICAgICAgICAgICAgaWYgKCEhbG9nZGlzcGxheSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhsb2dkaXNwbGF5LCBgIDogdGhlIHBhdHRlcm4gJyR7bmFtZX0nIG1hdGNoZXMgdGhlIHZhbHVlICcke25hbWV9J2ApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIXRoaXMuX3ByZXBhcmVkUGF0dGVybnMpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiB0aGlzLl9wcmVwYXJlZFBhdHRlcm5zKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFwYXR0ZXJuKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocGF0dGVybi5pc1R5cGVWYWx1ZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocGF0dGVybi5pc01hdGNoKG5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghIWxvZ2Rpc3BsYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGxvZ2Rpc3BsYXksIGAgOiB0aGUgcGF0dGVybiAnJHtwYXR0ZXJuLnRleHR9JyBtYXRjaGVzIHRoZSB2YWx1ZSAnJHtuYW1lfSdgKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cblxuLyoqXG4gKiBUaGlzIGNsYXNzIGlzIHVzZWQgdG8gcHJvY2VzcyBcImluY2x1ZGVkXCIgYW5kIFwiZXhjbHVkZWRcIiBwYXR0ZXJucyB0eXBpY2FsbHkgc3BlY2lmaWVkIGluIHRoZSBTaW5lcXVhIGNvbmZpZ3VyYXRpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBQYXR0ZXJuTWF0Y2hlciB7XG4gICAgcHVibGljIGluY2x1ZGVkUGF0dGVybjogUGF0dGVybnM7XG4gICAgcHVibGljIGV4Y2x1ZGVkUGF0dGVybjogUGF0dGVybnM7XG5cbiAgICBwdWJsaWMgZ2V0IGluY2x1ZGVkKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmluY2x1ZGVkUGF0dGVybi50ZXh0O1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgaW5jbHVkZWQodmFsdWU6IHN0cmluZyB8IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLmluY2x1ZGVkUGF0dGVybi50ZXh0ID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIGdldCBleGNsdWRlZCgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gdGhpcy5leGNsdWRlZFBhdHRlcm4udGV4dDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0IGV4Y2x1ZGVkKHZhbHVlOiBzdHJpbmcgfCB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5leGNsdWRlZFBhdHRlcm4udGV4dCA9IHZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgaW5jbHVkZWRMaXN0KHZhbHVlOiBzdHJpbmdbXSkge1xuICAgICAgICB0aGlzLmluY2x1ZGVkUGF0dGVybi5saXN0ID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBleGNsdWRlZExpc3QodmFsdWU6IHN0cmluZ1tdKSB7XG4gICAgICAgIHRoaXMuZXhjbHVkZWRQYXR0ZXJuLmxpc3QgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW5jbHVkZWRMb2dEaXNwbGF5Pzogc3RyaW5nO1xuICAgIHB1YmxpYyBleGNsdWRlZExvZ0Rpc3BsYXk/OiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihpbmNsdWRlZExvZ0Rpc3BsYXk/OiBzdHJpbmcsIGV4Y2x1ZGVkTG9nRGlzcGxheT86IHN0cmluZykge1xuICAgICAgICB0aGlzLmluY2x1ZGVkUGF0dGVybiA9IG5ldyBQYXR0ZXJucygpO1xuICAgICAgICB0aGlzLmV4Y2x1ZGVkUGF0dGVybiA9IG5ldyBQYXR0ZXJucygpO1xuICAgICAgICB0aGlzLmluY2x1ZGVkTG9nRGlzcGxheSA9IGluY2x1ZGVkTG9nRGlzcGxheTtcbiAgICAgICAgdGhpcy5leGNsdWRlZExvZ0Rpc3BsYXkgPSBleGNsdWRlZExvZ0Rpc3BsYXk7XG4gICAgfVxuXG4gICAgcHVibGljIGhhc1BhdHRlcm5zKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5pbmNsdWRlZFBhdHRlcm4uaGFzUGF0dGVybnMoKSB8fCB0aGlzLmV4Y2x1ZGVkUGF0dGVybi5oYXNQYXR0ZXJucygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc0V4Y2x1ZGVkKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gIXRoaXMuaXNJbmNsdWRlZChuYW1lKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNJbmNsdWRlZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKCFuYW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5pbmNsdWRlZFBhdHRlcm4uaGFzUGF0dGVybnMoKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZXhjbHVkZWRQYXR0ZXJuLmhhc1BhdHRlcm5zKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5leGNsdWRlZFBhdHRlcm4uaXNNYXRjaChuYW1lLCB0aGlzLmV4Y2x1ZGVkTG9nRGlzcGxheSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghdGhpcy5pbmNsdWRlZFBhdHRlcm4uaXNNYXRjaChuYW1lLCB0aGlzLmluY2x1ZGVkTG9nRGlzcGxheSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0aGlzLmV4Y2x1ZGVkUGF0dGVybi5oYXNQYXR0ZXJucygpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5leGNsdWRlZFBhdHRlcm4uaXNNYXRjaChuYW1lLCB0aGlzLmV4Y2x1ZGVkTG9nRGlzcGxheSkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaXNFeHBsaWNpdGx5SW5jbHVkZWQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmluY2x1ZGVkUGF0dGVybi5oYXNQYXR0ZXJucygpICYmIHRoaXMuaW5jbHVkZWRQYXR0ZXJuLmlzTWF0Y2gobmFtZSwgdGhpcy5pbmNsdWRlZExvZ0Rpc3BsYXkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpc0V4cGxpY2l0bHlFeGNsdWRlZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXhjbHVkZWRQYXR0ZXJuLmhhc1BhdHRlcm5zKCkgJiYgdGhpcy5leGNsdWRlZFBhdHRlcm4uaXNNYXRjaChuYW1lLCB0aGlzLmV4Y2x1ZGVkTG9nRGlzcGxheSk7XG4gICAgfVxufVxuIl19