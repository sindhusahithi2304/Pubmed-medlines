import { Subject, of } from "rxjs";
import { Utils } from "@sinequa/core/base";
/**
 * An implementation of the {@link IModalRef} interface.
 */
export class ModalRef {
    constructor(overlayRef) {
        this.overlayRef = overlayRef;
        this._checkClose = new Subject();
        this._beforeClosed = new Subject();
        this._afterClosed = new Subject();
        this.submitListener = (event) => {
            this.submitted = true;
            event.preventDefault();
            return false;
        };
    }
    /**
     * A stream that emits before the referenced modal is closed to allow an observer
     * to cancel the closing.
     */
    checkClose() {
        return this._checkClose.asObservable();
    }
    /**
     * A stream that emits before the referenced modal is closed.
     */
    beforeClosed() {
        return this._beforeClosed.asObservable();
    }
    /**
     * A stream that emits aftervthe referenced modal is closed.
     */
    afterClosed() {
        return this._afterClosed.asObservable();
    }
    /**
     * Close the referenced modal with the passed `result`.
     * @param result The referenced modal's result.
     */
    close(result = -2 /* Cancel */) {
        // Delay to allow submit handling
        Utils.delay().then(() => {
            const checkCloseEvent = { result };
            this._checkClose.next(checkCloseEvent);
            (checkCloseEvent.cancelled || of(false)).subscribe((cancelled) => {
                if (!cancelled) {
                    this._checkClose.complete();
                    this._beforeClosed.next(result);
                    this._beforeClosed.complete();
                    this.removeSubmitListener();
                    this.overlayRef.detachBackdrop();
                    this.overlayRef.dispose();
                    this.componentInstance = undefined;
                    this._afterClosed.next(result);
                    this._afterClosed.complete();
                }
            });
        });
    }
    /**
     * Disable the standard browser submit handling on any HTML form in the modal component.
     */
    disableSubmit() {
        if (!this.formElement) {
            const formElement = this.overlayRef.overlayElement.querySelector("form");
            if (formElement) {
                this.formElement = formElement;
                this.formElement.addEventListener("submit", this.submitListener);
            }
        }
    }
    removeSubmitListener() {
        if (this.formElement) {
            this.formElement.removeEventListener("submit", this.submitListener);
            this.formElement = undefined;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwtcmVmLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUvbW9kYWwvIiwic291cmNlcyI6WyJtb2RhbC1yZWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFDLE9BQU8sRUFBYyxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBK0N6Qzs7R0FFRztBQUNILE1BQU0sT0FBTyxRQUFRO0lBY2pCLFlBQW9CLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFMbEMsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBbUIsQ0FBQztRQUM3QyxrQkFBYSxHQUFHLElBQUksT0FBTyxFQUFlLENBQUM7UUFDM0MsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBZSxDQUFDO1FBdUQxQyxtQkFBYyxHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDL0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7WUFDdEIsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3ZCLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQTtJQXZERCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsVUFBVTtRQUNOLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMzQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxZQUFZO1FBQ1IsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVc7UUFDUCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDNUMsQ0FBQztJQUVEOzs7T0FHRztJQUNILEtBQUssQ0FBQyxNQUFNLGtCQUFxQjtRQUM3QixpQ0FBaUM7UUFDakMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDcEIsTUFBTSxlQUFlLEdBQW9CLEVBQUUsTUFBTSxFQUFFLENBQUM7WUFDcEQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDdkMsQ0FBQyxlQUFlLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FDOUMsQ0FBQyxTQUFTLEVBQUUsRUFBRTtnQkFDVixJQUFJLENBQUMsU0FBUyxFQUFFO29CQUNaLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQzVCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNoQyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUM5QixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztvQkFDNUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztvQkFDakMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztvQkFDMUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLFNBQVMsQ0FBQztvQkFDbkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQy9CLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUM7aUJBQ2hDO1lBQ0wsQ0FBQyxDQUNKLENBQUM7UUFDTixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFRRDs7T0FFRztJQUNILGFBQWE7UUFDVCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNuQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDekUsSUFBSSxXQUFXLEVBQUU7Z0JBQ2IsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7Z0JBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUNwRTtTQUNKO0lBQ0wsQ0FBQztJQUVPLG9CQUFvQjtRQUN4QixJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3BFLElBQUksQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDO1NBQ2hDO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtUeXBlfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHtPdmVybGF5UmVmfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQge1N1YmplY3QsIE9ic2VydmFibGUsIG9mfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHtVdGlsc30gZnJvbSBcIkBzaW5lcXVhL2NvcmUvYmFzZVwiO1xuaW1wb3J0IHtNb2RhbFJlc3VsdH0gZnJvbSBcIi4vbW9kYWwuc2VydmljZVwiO1xuXG4vKipcbiAqIERlc2NyaWJlcyB0aGUgZXZlbnQgcmFpc2VkIGJ5IGFuIHtAbGluayBJTW9kYWxSZWZ9IGluc3RhbmNlIGJlZm9yZSBhIG1vZGFsIGRpYWxvZyBpcyBjbG9zZWQuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2hlY2tDbG9zZUV2ZW50IHtcbiAgICAvKipcbiAgICAgKiBUaGUgcmVzdWx0IHBhc3NlZCB0byB0aGUgW0lNb2RhbFJlZi5jbG9zZV17QGxpbmsgSU1vZGFsUmVmI2Nsb3NlfSBtZXRob2QuXG4gICAgICovXG4gICAgcmVzdWx0OiBNb2RhbFJlc3VsdDtcbiAgICAvKipcbiAgICAgKiBBIGZsYWcgdGhhdCBjYW4gYmUgc2V0IGJ5IHRoZSBldmVudCByZWNlaXZlciB0byBpbmRpY2F0ZSB0aGF0IHRoZSBjbG9zaW5nIG9mIHRoZSBtb2RhbCBkaWFsb2dcbiAgICAgKiBzaG91bGQgYmUgY2FuY2VsbGVkLlxuICAgICAqL1xuICAgIGNhbmNlbGxlZD86IE9ic2VydmFibGU8Ym9vbGVhbj47XG59XG5cbi8qKlxuICogRGVzY3JpYmVzIHRoZSBvYmplY3QgcmV0dXJuZWQgYnkgdGhlIFtNb2RhbFNlcnZpY2Uub3BlblJlZl17QGxpbmsgTW9kYWxTZXJ2aWNlLm9wZW5SZWZ9IG1ldGhvZFxuICogdG8gbWFpbnRhaW4gYSByZWZlcmVuY2UgdG8gdGhlIG9wZW5lZCBtb2RhbC5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJTW9kYWxSZWYge1xuICAgIC8qKlxuICAgICAqIFRoZSBjb21wb25lbnQgaW5zdGFuY2Ugb2YgdGhlIHJlZmVyZW5jZWQgbW9kYWwgY29tcG9uZW50LlxuICAgICAqL1xuICAgIGNvbXBvbmVudEluc3RhbmNlOiBUeXBlPGFueT4gfCB1bmRlZmluZWQ7XG4gICAgLyoqXG4gICAgICogQSBzdHJlYW0gdGhhdCBlbWl0cyBiZWZvcmUgdGhlIHJlZmVyZW5jZWQgbW9kYWwgaXMgY2xvc2VkIHRvIGFsbG93IGFuIG9ic2VydmVyXG4gICAgICogdG8gY2FuY2VsIHRoZSBjbG9zaW5nLlxuICAgICAqL1xuICAgIGNoZWNrQ2xvc2UoKTogT2JzZXJ2YWJsZTxDaGVja0Nsb3NlRXZlbnQ+O1xuICAgIC8qKlxuICAgICAqIEEgc3RyZWFtIHRoYXQgZW1pdHMgYmVmb3JlIHRoZSByZWZlcmVuY2VkIG1vZGFsIGlzIGNsb3NlZC5cbiAgICAgKi9cbiAgICBiZWZvcmVDbG9zZWQoKTogT2JzZXJ2YWJsZTxNb2RhbFJlc3VsdD47XG4gICAgLyoqXG4gICAgICogQSBzdHJlYW0gdGhhdCBlbWl0cyBhZnRlciB0aGUgcmVmZXJlbmNlZCBtb2RhbCBpcyBjbG9zZWQuXG4gICAgICovXG4gICAgYWZ0ZXJDbG9zZWQoKTogT2JzZXJ2YWJsZTxNb2RhbFJlc3VsdD47XG4gICAgLyoqXG4gICAgICogQ2xvc2UgdGhlIHJlZmVyZW5jZWQgbW9kYWwgd2l0aCB0aGUgcGFzc2VkIGByZXN1bHRgLlxuICAgICAqIEBwYXJhbSByZXN1bHQgVGhlIHJlZmVyZW5jZWQgbW9kYWwncyByZXN1bHQuXG4gICAgICovXG4gICAgY2xvc2UocmVzdWx0OiBNb2RhbFJlc3VsdCk7XG59XG5cbi8qKlxuICogQW4gaW1wbGVtZW50YXRpb24gb2YgdGhlIHtAbGluayBJTW9kYWxSZWZ9IGludGVyZmFjZS5cbiAqL1xuZXhwb3J0IGNsYXNzIE1vZGFsUmVmIGltcGxlbWVudHMgSU1vZGFsUmVmIHtcbiAgICAvKipcbiAgICAgKiBUaGUgY29tcG9uZW50IGluc3RhbmNlIG9mIHRoZSByZWZlcmVuY2VkIG1vZGFsIGNvbXBvbmVudC5cbiAgICAgKi9cbiAgICBjb21wb25lbnRJbnN0YW5jZTogVHlwZTxhbnk+IHwgdW5kZWZpbmVkO1xuICAgIC8qKlxuICAgICAqIEEgZmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHJlZmVyZW5jZWQgbW9kYWwgaGFzIGJlZW4gc3VibWl0dGVkLlxuICAgICAqL1xuICAgIHN1Ym1pdHRlZDogYm9vbGVhbjtcbiAgICBwcml2YXRlIF9jaGVja0Nsb3NlID0gbmV3IFN1YmplY3Q8Q2hlY2tDbG9zZUV2ZW50PigpO1xuICAgIHByaXZhdGUgX2JlZm9yZUNsb3NlZCA9IG5ldyBTdWJqZWN0PE1vZGFsUmVzdWx0PigpO1xuICAgIHByaXZhdGUgX2FmdGVyQ2xvc2VkID0gbmV3IFN1YmplY3Q8TW9kYWxSZXN1bHQ+KCk7XG4gICAgcHJpdmF0ZSBmb3JtRWxlbWVudDogSFRNTEZvcm1FbGVtZW50IHwgdW5kZWZpbmVkO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBvdmVybGF5UmVmOiBPdmVybGF5UmVmKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQSBzdHJlYW0gdGhhdCBlbWl0cyBiZWZvcmUgdGhlIHJlZmVyZW5jZWQgbW9kYWwgaXMgY2xvc2VkIHRvIGFsbG93IGFuIG9ic2VydmVyXG4gICAgICogdG8gY2FuY2VsIHRoZSBjbG9zaW5nLlxuICAgICAqL1xuICAgIGNoZWNrQ2xvc2UoKTogT2JzZXJ2YWJsZTxDaGVja0Nsb3NlRXZlbnQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NoZWNrQ2xvc2UuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQSBzdHJlYW0gdGhhdCBlbWl0cyBiZWZvcmUgdGhlIHJlZmVyZW5jZWQgbW9kYWwgaXMgY2xvc2VkLlxuICAgICAqL1xuICAgIGJlZm9yZUNsb3NlZCgpOiBPYnNlcnZhYmxlPE1vZGFsUmVzdWx0PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9iZWZvcmVDbG9zZWQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQSBzdHJlYW0gdGhhdCBlbWl0cyBhZnRlcnZ0aGUgcmVmZXJlbmNlZCBtb2RhbCBpcyBjbG9zZWQuXG4gICAgICovXG4gICAgYWZ0ZXJDbG9zZWQoKTogT2JzZXJ2YWJsZTxNb2RhbFJlc3VsdD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fYWZ0ZXJDbG9zZWQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2xvc2UgdGhlIHJlZmVyZW5jZWQgbW9kYWwgd2l0aCB0aGUgcGFzc2VkIGByZXN1bHRgLlxuICAgICAqIEBwYXJhbSByZXN1bHQgVGhlIHJlZmVyZW5jZWQgbW9kYWwncyByZXN1bHQuXG4gICAgICovXG4gICAgY2xvc2UocmVzdWx0ID0gTW9kYWxSZXN1bHQuQ2FuY2VsKSB7XG4gICAgICAgIC8vIERlbGF5IHRvIGFsbG93IHN1Ym1pdCBoYW5kbGluZ1xuICAgICAgICBVdGlscy5kZWxheSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2hlY2tDbG9zZUV2ZW50OiBDaGVja0Nsb3NlRXZlbnQgPSB7IHJlc3VsdCB9O1xuICAgICAgICAgICAgdGhpcy5fY2hlY2tDbG9zZS5uZXh0KGNoZWNrQ2xvc2VFdmVudCk7XG4gICAgICAgICAgICAoY2hlY2tDbG9zZUV2ZW50LmNhbmNlbGxlZCB8fCBvZihmYWxzZSkpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoY2FuY2VsbGVkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY2FuY2VsbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGVja0Nsb3NlLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9iZWZvcmVDbG9zZWQubmV4dChyZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYmVmb3JlQ2xvc2VkLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVN1Ym1pdExpc3RlbmVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm92ZXJsYXlSZWYuZGV0YWNoQmFja2Ryb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3ZlcmxheVJlZi5kaXNwb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBvbmVudEluc3RhbmNlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWZ0ZXJDbG9zZWQubmV4dChyZXN1bHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWZ0ZXJDbG9zZWQuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3VibWl0TGlzdGVuZXIgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgdGhpcy5zdWJtaXR0ZWQgPSB0cnVlO1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGlzYWJsZSB0aGUgc3RhbmRhcmQgYnJvd3NlciBzdWJtaXQgaGFuZGxpbmcgb24gYW55IEhUTUwgZm9ybSBpbiB0aGUgbW9kYWwgY29tcG9uZW50LlxuICAgICAqL1xuICAgIGRpc2FibGVTdWJtaXQoKSB7XG4gICAgICAgIGlmICghdGhpcy5mb3JtRWxlbWVudCkge1xuICAgICAgICAgICAgY29uc3QgZm9ybUVsZW1lbnQgPSB0aGlzLm92ZXJsYXlSZWYub3ZlcmxheUVsZW1lbnQucXVlcnlTZWxlY3RvcihcImZvcm1cIik7XG4gICAgICAgICAgICBpZiAoZm9ybUVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvcm1FbGVtZW50ID0gZm9ybUVsZW1lbnQ7XG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwic3VibWl0XCIsIHRoaXMuc3VibWl0TGlzdGVuZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW1vdmVTdWJtaXRMaXN0ZW5lcigpIHtcbiAgICAgICAgaWYgKHRoaXMuZm9ybUVsZW1lbnQpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInN1Ym1pdFwiLCB0aGlzLnN1Ym1pdExpc3RlbmVyKTtcbiAgICAgICAgICAgIHRoaXMuZm9ybUVsZW1lbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=